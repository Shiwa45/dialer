;===============================================
; Outbound Campaign Context
; Add this to /etc/asterisk/extensions.conf
;===============================================

[from-campaign]
; This context handles outbound calls from the predictive dialer
; Pattern: Any number dialed will be sent through your trunk

exten => _X.,1,NoOp(Outbound Campaign Call to ${EXTEN})
 same => n,Set(CHANNEL(hangup_handler_push)=hangup-handler,s,1)
 
 ; Check if AMD is enabled
 same => n,GotoIf($["${AMD_ENABLED}" = "1"]?amd:dial)

; AMD Branch - Detect answering machine
 same => n(amd),Answer()
 same => n,AMD(${AMD_SILENCE},${AMD_AFTER_GREETING_SILENCE},${AMD_TOTAL_ANALYSIS_TIME},${AMD_MIN_WORD_LENGTH},${AMD_BETWEEN_WORDS_SILENCE},${AMD_MAXIMUM_NUMBER_OF_WORDS},${AMD_MAXIMUM_WORD_LENGTH})
 same => n,NoOp(AMD Result: ${AMDSTATUS} - ${AMDCAUSE})
 same => n,Set(AMD_STATUS=${AMDSTATUS})
 same => n,Set(AMD_CAUSE=${AMDCAUSE})
 same => n,GotoIf($["${AMDSTATUS}" = "MACHINE"]?machine:human)

; Machine detected - hangup
 same => n(machine),NoOp(Machine detected - hanging up)
 same => n,Hangup()

; Human detected or AMD disabled - continue to Stasis
 same => n(human),NoOp(Human detected - routing to Stasis)
 same => n,Goto(dial)

; Dial the number through your trunk
 same => n(dial),Dial(SIP/${EXTEN}@your-trunk-name,${DIAL_TIMEOUT})
 
 ; After dial completes, send to Stasis app
 same => n,Stasis(autodialer,${CALL_TYPE},${CAMPAIGN_ID},${LEAD_ID},${HOPPER_ID})
 same => n,Hangup()

; If dial fails
 same => n,Hangup()

;===============================================
; Hangup Handler
;===============================================
[hangup-handler]
exten => s,1,NoOp(Call ended)
 same => n,Return()
