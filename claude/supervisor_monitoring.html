{% extends 'base.html' %}
{% load static %}

{% block title %}Call Monitoring - Supervisor{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #4361ee;
        --success-color: #06d6a0;
        --warning-color: #ffd166;
        --danger-color: #ef476f;
    }

    body {
        background: #f5f7fb;
    }

    .monitoring-header {
        background: white;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
    }

    .agent-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1rem;
        padding: 1rem;
    }

    .agent-monitor-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        transition: all 0.2s;
    }

    .agent-monitor-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .agent-monitor-card.on-call {
        border: 2px solid var(--danger-color);
    }

    .agent-card-header {
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .agent-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
    }

    .agent-avatar.on-call {
        animation: pulse-ring 1.5s infinite;
    }

    @keyframes pulse-ring {
        0% { box-shadow: 0 0 0 0 rgba(239, 71, 111, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(239, 71, 111, 0); }
        100% { box-shadow: 0 0 0 0 rgba(239, 71, 111, 0); }
    }

    .agent-info {
        flex: 1;
    }

    .agent-name {
        font-weight: 600;
        font-size: 1rem;
        color: #333;
    }

    .agent-extension {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .agent-status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .agent-status-badge.available {
        background: rgba(6, 214, 160, 0.1);
        color: var(--success-color);
    }

    .agent-status-badge.busy {
        background: rgba(239, 71, 111, 0.1);
        color: var(--danger-color);
    }

    .agent-status-badge.break {
        background: rgba(255, 209, 102, 0.1);
        color: #b5830a;
    }

    .agent-card-body {
        padding: 1rem;
    }

    .call-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .call-info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .call-info-row:last-child {
        margin-bottom: 0;
    }

    .call-info-label {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
    }

    .call-info-value {
        font-weight: 600;
        color: #333;
    }

    .call-timer {
        font-family: 'Courier New', monospace;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--danger-color);
        text-align: center;
        padding: 0.5rem;
    }

    .monitor-controls {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    .monitor-btn {
        flex: 1;
        padding: 0.5rem;
        border: none;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .monitor-btn.listen {
        background: rgba(67, 97, 238, 0.1);
        color: var(--primary-color);
    }

    .monitor-btn.whisper {
        background: rgba(255, 209, 102, 0.1);
        color: #b5830a;
    }

    .monitor-btn.barge {
        background: rgba(239, 71, 111, 0.1);
        color: var(--danger-color);
    }

    .monitor-btn:hover {
        transform: translateY(-1px);
    }

    .monitor-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .monitor-btn.active {
        color: white;
    }

    .monitor-btn.listen.active { background: var(--primary-color); }
    .monitor-btn.whisper.active { background: var(--warning-color); color: #333; }
    .monitor-btn.barge.active { background: var(--danger-color); }

    .quality-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .quality-badge.excellent { background: rgba(6, 214, 160, 0.1); color: var(--success-color); }
    .quality-badge.good { background: rgba(67, 97, 238, 0.1); color: var(--primary-color); }
    .quality-badge.average { background: rgba(255, 209, 102, 0.1); color: #b5830a; }
    .quality-badge.poor { background: rgba(239, 71, 111, 0.1); color: var(--danger-color); }

    .no-call-message {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 1rem;
    }

    /* Active Monitoring Panel */
    .active-monitoring-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        color: white;
        padding: 1rem 2rem;
        display: none;
        z-index: 1000;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
    }

    .active-monitoring-panel.active {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .monitoring-info {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .monitoring-mode {
        padding: 0.5rem 1rem;
        background: rgba(255,255,255,0.2);
        border-radius: 20px;
        font-weight: 600;
    }

    .monitoring-agent {
        font-size: 1.1rem;
    }

    .monitoring-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .mode-switch-btn {
        padding: 0.5rem 1rem;
        border: 2px solid white;
        background: transparent;
        color: white;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .mode-switch-btn:hover {
        background: white;
        color: #1e3c72;
    }

    .mode-switch-btn.active {
        background: white;
        color: #1e3c72;
    }

    .stop-monitoring-btn {
        padding: 0.5rem 1.5rem;
        background: var(--danger-color);
        border: none;
        color: white;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

    /* Stats Summary */
    .stats-summary {
        display: flex;
        gap: 2rem;
        padding: 1rem 1.5rem;
        background: white;
        border-radius: 12px;
        margin: 0 1rem 1rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .stat-label {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="monitoring-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-0"><i class="fas fa-headset me-2"></i>Call Monitoring</h4>
            <small class="text-muted">Monitor, coach, and support your agents in real-time</small>
        </div>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="campaignFilter" style="width: 200px;">
                <option value="">All Campaigns</option>
                {% for campaign in campaigns %}
                <option value="{{ campaign.id }}">{{ campaign.name }}</option>
                {% endfor %}
            </select>
            <button class="btn btn-outline-primary btn-sm" onclick="refreshAgents()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>
</div>

<!-- Stats Summary -->
<div class="stats-summary">
    <div class="stat-item">
        <div class="stat-value" id="totalAgents">0</div>
        <div class="stat-label">Total Agents</div>
    </div>
    <div class="stat-item">
        <div class="stat-value text-success" id="availableAgents">0</div>
        <div class="stat-label">Available</div>
    </div>
    <div class="stat-item">
        <div class="stat-value text-danger" id="busyAgents">0</div>
        <div class="stat-label">On Call</div>
    </div>
    <div class="stat-item">
        <div class="stat-value text-warning" id="pausedAgents">0</div>
        <div class="stat-label">Paused</div>
    </div>
</div>

<!-- Agent Grid -->
<div class="agent-grid" id="agentGrid">
    <!-- Agent cards will be loaded here -->
    <div class="text-center py-5 text-muted">
        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
        <p>Loading agents...</p>
    </div>
</div>

<!-- Active Monitoring Panel -->
<div class="active-monitoring-panel" id="monitoringPanel">
    <div class="monitoring-info">
        <div class="monitoring-mode" id="monitoringMode">
            <i class="fas fa-headphones me-1"></i>
            <span>Listening</span>
        </div>
        <div class="monitoring-agent">
            Monitoring: <strong id="monitoringAgentName">John Smith</strong>
        </div>
        <div class="monitoring-timer" id="monitoringTimer">0:00</div>
    </div>
    <div class="monitoring-controls">
        <button class="mode-switch-btn active" data-mode="listen" onclick="switchMode('listen')">
            <i class="fas fa-headphones me-1"></i>Listen
        </button>
        <button class="mode-switch-btn" data-mode="whisper" onclick="switchMode('whisper')">
            <i class="fas fa-comment-dots me-1"></i>Whisper
        </button>
        <button class="mode-switch-btn" data-mode="barge" onclick="switchMode('barge')">
            <i class="fas fa-bullhorn me-1"></i>Barge
        </button>
        <button class="stop-monitoring-btn" onclick="stopMonitoring()">
            <i class="fas fa-stop me-1"></i>Stop
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// State
let agents = [];
let currentMonitoring = null;
let monitoringTimer = null;
let ws = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadAgents();
    initWebSocket();
    
    // Refresh every 5 seconds
    setInterval(loadAgents, 5000);
});

function initWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${window.location.host}/ws/supervisor/monitoring/`);
    
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
    };
    
    ws.onclose = function() {
        setTimeout(initWebSocket, 3000);
    };
}

function handleWebSocketMessage(data) {
    if (data.type === 'agent_update') {
        updateAgentCard(data.agent);
    } else if (data.type === 'call_update') {
        loadAgents();
    }
}

function loadAgents() {
    const campaign = document.getElementById('campaignFilter').value;
    let url = '{% url "reports:monitoring_agents_api" %}';
    if (campaign) url += `?campaign=${campaign}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                agents = data.agents;
                renderAgents(agents);
                updateStats(data.stats);
            }
        });
}

function refreshAgents() {
    loadAgents();
}

function renderAgents(agents) {
    const grid = document.getElementById('agentGrid');
    
    if (!agents || agents.length === 0) {
        grid.innerHTML = `
            <div class="text-center py-5 text-muted" style="grid-column: 1 / -1;">
                <i class="fas fa-user-slash fa-3x mb-3"></i>
                <p>No agents online</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = agents.map(agent => renderAgentCard(agent)).join('');
}

function renderAgentCard(agent) {
    const isOnCall = agent.status === 'busy' && agent.current_call;
    const initials = getInitials(agent.name);
    
    return `
        <div class="agent-monitor-card ${isOnCall ? 'on-call' : ''}" data-agent-id="${agent.id}">
            <div class="agent-card-header">
                <div class="agent-avatar ${isOnCall ? 'on-call' : ''}">
                    ${initials}
                </div>
                <div class="agent-info">
                    <div class="agent-name">${agent.name}</div>
                    <div class="agent-extension">Ext: ${agent.extension || 'N/A'}</div>
                </div>
                <span class="agent-status-badge ${agent.status}">
                    ${capitalizeFirst(agent.status)}
                </span>
            </div>
            <div class="agent-card-body">
                ${isOnCall ? renderCallInfo(agent) : renderNoCall()}
                <div class="monitor-controls">
                    <button class="monitor-btn listen" onclick="startMonitoring(${agent.id}, 'listen')" ${!isOnCall ? 'disabled' : ''}>
                        <i class="fas fa-headphones"></i>Listen
                    </button>
                    <button class="monitor-btn whisper" onclick="startMonitoring(${agent.id}, 'whisper')" ${!isOnCall ? 'disabled' : ''}>
                        <i class="fas fa-comment-dots"></i>Whisper
                    </button>
                    <button class="monitor-btn barge" onclick="startMonitoring(${agent.id}, 'barge')" ${!isOnCall ? 'disabled' : ''}>
                        <i class="fas fa-bullhorn"></i>Barge
                    </button>
                </div>
            </div>
        </div>
    `;
}

function renderCallInfo(agent) {
    const call = agent.current_call;
    return `
        <div class="call-info">
            <div class="call-timer" id="timer-${agent.id}">${formatDuration(call.duration || 0)}</div>
            <div class="call-info-row">
                <span class="call-info-label">Number</span>
                <span class="call-info-value">${call.phone_number || 'Unknown'}</span>
            </div>
            <div class="call-info-row">
                <span class="call-info-label">Lead</span>
                <span class="call-info-value">${call.lead_name || 'N/A'}</span>
            </div>
            ${call.quality_score ? `
            <div class="call-info-row">
                <span class="call-info-label">Quality</span>
                <span class="quality-badge ${getQualityClass(call.quality_score)}">
                    <i class="fas fa-star"></i>${call.quality_score}
                </span>
            </div>
            ` : ''}
        </div>
    `;
}

function renderNoCall() {
    return `
        <div class="no-call-message">
            <i class="fas fa-phone-slash me-2"></i>Not on a call
        </div>
    `;
}

function updateStats(stats) {
    document.getElementById('totalAgents').textContent = stats.total || 0;
    document.getElementById('availableAgents').textContent = stats.available || 0;
    document.getElementById('busyAgents').textContent = stats.busy || 0;
    document.getElementById('pausedAgents').textContent = stats.paused || 0;
}

function startMonitoring(agentId, mode) {
    const agent = agents.find(a => a.id === agentId);
    if (!agent) return;
    
    fetch('{% url "reports:start_monitoring" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            agent_id: agentId,
            mode: mode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentMonitoring = {
                agentId: agentId,
                agentName: agent.name,
                mode: mode,
                sessionId: data.session_id,
                startTime: Date.now()
            };
            
            showMonitoringPanel();
            startMonitoringTimer();
            
            // Update button states
            updateMonitorButtons(agentId, mode);
        } else {
            alert(data.error || 'Failed to start monitoring');
        }
    });
}

function switchMode(newMode) {
    if (!currentMonitoring) return;
    
    fetch('{% url "reports:switch_monitoring_mode" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            session_id: currentMonitoring.sessionId,
            mode: newMode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentMonitoring.mode = newMode;
            updateMonitoringMode(newMode);
        }
    });
}

function stopMonitoring() {
    if (!currentMonitoring) return;
    
    fetch('{% url "reports:stop_monitoring" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            session_id: currentMonitoring.sessionId
        })
    })
    .then(response => response.json())
    .then(data => {
        hideMonitoringPanel();
        stopMonitoringTimer();
        currentMonitoring = null;
        loadAgents();
    });
}

function showMonitoringPanel() {
    const panel = document.getElementById('monitoringPanel');
    panel.classList.add('active');
    
    document.getElementById('monitoringAgentName').textContent = currentMonitoring.agentName;
    updateMonitoringMode(currentMonitoring.mode);
}

function hideMonitoringPanel() {
    document.getElementById('monitoringPanel').classList.remove('active');
}

function updateMonitoringMode(mode) {
    const modeNames = {
        'listen': 'Listening',
        'whisper': 'Whispering',
        'barge': 'Barged In'
    };
    
    const modeIcons = {
        'listen': 'headphones',
        'whisper': 'comment-dots',
        'barge': 'bullhorn'
    };
    
    document.getElementById('monitoringMode').innerHTML = `
        <i class="fas fa-${modeIcons[mode]} me-1"></i>
        <span>${modeNames[mode]}</span>
    `;
    
    // Update mode buttons
    document.querySelectorAll('.mode-switch-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
    });
}

function startMonitoringTimer() {
    stopMonitoringTimer();
    
    monitoringTimer = setInterval(() => {
        if (currentMonitoring) {
            const elapsed = Math.floor((Date.now() - currentMonitoring.startTime) / 1000);
            document.getElementById('monitoringTimer').textContent = formatDuration(elapsed);
        }
    }, 1000);
}

function stopMonitoringTimer() {
    if (monitoringTimer) {
        clearInterval(monitoringTimer);
        monitoringTimer = null;
    }
}

function updateMonitorButtons(agentId, mode) {
    const card = document.querySelector(`[data-agent-id="${agentId}"]`);
    if (card) {
        card.querySelectorAll('.monitor-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        card.querySelector(`.monitor-btn.${mode}`).classList.add('active');
    }
}

function updateAgentCard(agent) {
    const card = document.querySelector(`[data-agent-id="${agent.id}"]`);
    if (card) {
        card.outerHTML = renderAgentCard(agent);
    }
}

// Helpers
function getInitials(name) {
    if (!name) return '?';
    const parts = name.split(' ');
    if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
}

function capitalizeFirst(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function formatDuration(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}:${String(s).padStart(2, '0')}`;
}

function getQualityClass(score) {
    if (score >= 90) return 'excellent';
    if (score >= 75) return 'good';
    if (score >= 60) return 'average';
    return 'poor';
}

// Filter change handler
document.getElementById('campaignFilter').addEventListener('change', loadAgents);
</script>
{% endblock %}
