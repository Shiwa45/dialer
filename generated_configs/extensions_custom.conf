; ---------------------------------------------------------------------
; Custom dialplan for openvox carrier - routes all calls without prefix stripping
; Generated: 2026-02-01
; ---------------------------------------------------------------------

[from-campaign]

; AMD and Stasis handler for predictive dialer
exten => _X.,1,NoOp(Outbound Campaign Call to ${EXTEN})
 same => n,Set(CHANNEL(hangup_handler_push)=hangup-handler,s,1)
 same => n,Set(DIAL_TIMEOUT=${DIAL_TIMEOUT:-30})

; Recording Setup
 same => n,Set(RECORDING_FILENAME=out-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}-${CAMPAIGN_ID}-${LEAD_ID}-${EXTEN})
 same => n,Set(RECORDING_FILE=/var/spool/asterisk/monitor/${STRFTIME(${EPOCH},,%Y/%m/%d)}/${RECORDING_FILENAME})
 same => n,System(mkdir -p /var/spool/asterisk/monitor/${STRFTIME(${EPOCH},,%Y/%m/%d)})
 same => n,MixMonitor(${RECORDING_FILE}.wav,b)

; Check if AMD is enabled
 same => n,GotoIf($["${AMD_ENABLED}" = "1"]?dial_carrier:dial_direct)

; Dial carrier with full number (no prefix stripping)
 same => n(dial_carrier),NoOp(Dialing ${EXTEN} via openvox)
 same => n,Set(EFFECTIVE_DIAL_TIMEOUT=${IF($["${DIAL_TIMEOUT}"=""]?60:${DIAL_TIMEOUT})})
 ; Check if number starts with 9119 and strip it
 same => n,GotoIf($["${EXTEN:0:4}" = "9119"]?strip_prefix:dial_full)
 same => n(strip_prefix),Set(OUTNUM=${EXTEN:4})
 same => n,Goto(do_dial)
 same => n(dial_full),Set(OUTNUM=${EXTEN})
 same => n(do_dial),NoOp(Dialing ${OUTNUM} to carrier)
 same => n,Dial(PJSIP/openvox/sip:${OUTNUM}@192.168.1.111:5060,${EFFECTIVE_DIAL_TIMEOUT},U(amd-handler^${CALL_TYPE:-autodial}^${CAMPAIGN_ID}^${LEAD_ID}^${HOPPER_ID}))
 same => n,Goto(failed)

 same => n(failed),NoOp(Call failed: ${DIALSTATUS})
 same => n,Hangup()

; Direct dial (no AMD)
 same => n(dial_direct),Goto(dial_carrier)

; Holding extension for Local channel
exten => wait_for_call,1,Answer()
 same => n,Wait(7200)
 same => n,Hangup()

[amd-handler]
exten => s,1,NoOp(Call answered - checking AMD)
 same => n,Set(CALL_TYPE=${IF($["${ARG1}"=""]?${CALL_TYPE}:${ARG1})})
 same => n,Set(CAMPAIGN_ID=${IF($["${ARG2}"=""]?${CAMPAIGN_ID}:${ARG2})})
 same => n,Set(LEAD_ID=${IF($["${ARG3}"=""]?${LEAD_ID}:${ARG3})})
 same => n,Set(HOPPER_ID=${IF($["${ARG4}"=""]?${HOPPER_ID}:${ARG4})})
 same => n,GotoIf($["${AMD_ENABLED}" = "1"]?run_amd:send_to_stasis)

; Run AMD
 same => n(run_amd),AMD(${AMD_SILENCE:-2500},${AMD_AFTER_GREETING_SILENCE:-800},${AMD_TOTAL_ANALYSIS_TIME:-5000},${AMD_MIN_WORD_LENGTH:-100},${AMD_BETWEEN_WORDS_SILENCE:-50},${AMD_MAXIMUM_NUMBER_OF_WORDS:-3},${AMD_MAXIMUM_WORD_LENGTH:-5000})
 same => n,NoOp(AMD Result: ${AMDSTATUS} - ${AMDCAUSE})
 same => n,Set(AMD_STATUS=${AMDSTATUS})
 same => n,Set(AMD_CAUSE=${AMDCAUSE})
 same => n,GotoIf($["${AMDSTATUS}" = "MACHINE"]?machine:send_to_stasis)

; Machine detected - hangup
 same => n(machine),NoOp(Machine detected - hanging up)
 same => n,Hangup()

; Human or no AMD - send to Stasis for agent routing
 same => n(send_to_stasis),Stasis(autodialer,${CALL_TYPE},${CAMPAIGN_ID},${LEAD_ID},${HOPPER_ID})
 same => n,Return()

[agent-bridge]
; Bridge agent to customer channel
exten => _.,1,NoOp(Bridging agent to customer ${EXTEN})
 same => n,Set(__CALL_TYPE=${CALL_TYPE})
 same => n,Set(__CUSTOMER_CHANNEL=${CUSTOMER_CHANNEL})
 same => n,Set(__LEAD_ID=${LEAD_ID})
 same => n,Set(__CAMPAIGN_ID=${CAMPAIGN_ID})
 same => n,Set(__AGENT_ID=${AGENT_ID})
 same => n,Answer()
 same => n,Bridge(${CUSTOMER_CHANNEL},kKhH)
 same => n,Hangup()

[hangup-handler]
exten => s,1,NoOp(Call ended)
 same => n,Return()
