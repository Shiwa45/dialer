; ---------------------------------------------------------------------
; Autogenerated outbound dialplan with AMD and Stasis support
; Generated: 2025-12-23 07:38:59 UTC
; Context: from-campaign
; Command: manage.py render_carrier_configs
; ---------------------------------------------------------------------

[from-campaign]

; AMD and Stasis handler for predictive dialer
exten => _X.,1,NoOp(Outbound Campaign Call to ${EXTEN})
 same => n,Set(CHANNEL(hangup_handler_push)=hangup-handler,s,1)
 same => n,Set(DIAL_TIMEOUT=${DIAL_TIMEOUT:-30})

; Check if AMD is enabled
 same => n,GotoIf($["${AMD_ENABLED}" = "1"]?find_carrier:dial_direct)

; Find matching carrier by prefix
 same => n,GotoIf($["${EXTEN:0:4}" = "9119"]?carrier_0)
 same => n,Goto(carrier_0)

; Carrier openvox (priority 1)
 same => n(carrier_0),Set(OUTNUM=${EXTEN:4})
same => n,Dial(PJSIP/openvox/sip:${OUTNUM}@192.168.1.113:5060,${DIAL_TIMEOUT},U(amd-handler^${CALL_TYPE:-autodial}^${CAMPAIGN_ID}^${LEAD_ID}^${HOPPER_ID}))
 same => n,Goto(failed)

 same => n(failed),NoOp(Call failed: ${DIALSTATUS})
 same => n,Hangup()

; Direct dial (no AMD)
 same => n(dial_direct),Goto(carrier_0)

; Holding extension for Local channel
exten => wait_for_call,1,Answer()
 same => n,Wait(7200)
 same => n,Hangup()

[amd-handler]
exten => s,1,NoOp(Call answered - checking AMD)
 same => n,Set(CALL_TYPE=${IF($["${ARG1}"=""]?${CALL_TYPE}:${ARG1})})
 same => n,Set(CAMPAIGN_ID=${IF($["${ARG2}"=""]?${CAMPAIGN_ID}:${ARG2})})
 same => n,Set(LEAD_ID=${IF($["${ARG3}"=""]?${LEAD_ID}:${ARG3})})
 same => n,Set(HOPPER_ID=${IF($["${ARG4}"=""]?${HOPPER_ID}:${ARG4})})
 same => n,GotoIf($["${AMD_ENABLED}" = "1"]?run_amd:send_to_stasis)

; Run AMD
 same => n(run_amd),AMD(${AMD_SILENCE:-2500},${AMD_AFTER_GREETING_SILENCE:-800},${AMD_TOTAL_ANALYSIS_TIME:-5000},${AMD_MIN_WORD_LENGTH:-100},${AMD_BETWEEN_WORDS_SILENCE:-50},${AMD_MAXIMUM_NUMBER_OF_WORDS:-3},${AMD_MAXIMUM_WORD_LENGTH:-5000})
 same => n,NoOp(AMD Result: ${AMDSTATUS} - ${AMDCAUSE})
 same => n,Set(AMD_STATUS=${AMDSTATUS})
 same => n,Set(AMD_CAUSE=${AMDCAUSE})
 same => n,GotoIf($["${AMDSTATUS}" = "MACHINE"]?machine:send_to_stasis)

; Machine detected - hangup
 same => n(machine),NoOp(Machine detected - hanging up)
 same => n,Hangup()

; Human or no AMD - send to Stasis for agent routing
 same => n(send_to_stasis),Stasis(autodialer,${CALL_TYPE},${CAMPAIGN_ID},${LEAD_ID},${HOPPER_ID})
 same => n,Return()

[hangup-handler]
exten => s,1,NoOp(Call ended)
 same => n,Return()
