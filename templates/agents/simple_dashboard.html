{% extends 'base.html' %}
{% block title %}Agent Panel - {{ block.super }}{% endblock %}
{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">Agent Panel</h3>
      <small class="text-muted">Welcome, {{ user.get_full_name|default:user.username }} | Status: <span id="currentStatus">{{ agent_status.get_status_display }}</span></small>
    </div>
    <span id="phoneStatus" class="badge bg-secondary">Not Registered</span>
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card mb-3">
        <div class="card-header">Manual Dial</div>
        <div class="card-body">
          <form method="post" action="{% url 'agents:manual_dial' %}" class="row g-2">
            {% csrf_token %}
            <div class="col-md-4">
              <select name="campaign_id" class="form-select">
                {% for c in assigned_campaigns %}
                <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <input type="text" name="phone_number" class="form-control" placeholder="Enter number to dial" />
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary" type="submit">Dial</button>
            </div>
          </form>
          <small class="text-muted">Dials customer first, then your extension, and bridges automatically.</small>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Lead & Notes</div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-6"><input class="form-control" placeholder="First Name"></div>
            <div class="col-md-6"><input class="form-control" placeholder="Last Name"></div>
            <div class="col-md-6"><input class="form-control" placeholder="Phone Number"></div>
            <div class="col-md-6"><input class="form-control" placeholder="Email"></div>
            <div class="col-md-6">
              <select class="form-select">
                <option>Lead Status</option>
                <option>New</option>
                <option>Contacted</option>
                <option>Callback</option>
                <option>Sale</option>
              </select>
            </div>
            <div class="col-md-6">
              <select class="form-select">
                <option>Priority</option>
                <option>Low</option>
                <option>Medium</option>
                <option>High</option>
              </select>
            </div>
            <div class="col-12"><textarea class="form-control" rows="5" placeholder="Enter call notes..."></textarea></div>
            <div class="col-12">
              <div class="alert alert-light mb-0">{{ script_content|default:"Hello, this is [Agent Name] calling from [Company]. How are you today?" }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Browser Phone</span>
          <span id="webrtcRegBadge" class="badge bg-secondary">Not Registered</span>
        </div>
        <div class="card-body">
          <div class="input-group mb-2">
            <input type="text" id="webrtcNumber" class="form-control" placeholder="Enter number (e.g., 7000)">
            <button class="btn btn-primary" type="button" onclick="webrtcCall()">Call</button>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" type="button" onclick="webrtcAnswer()">Answer</button>
            <button class="btn btn-danger btn-sm" type="button" onclick="webrtcHangup()">Hangup</button>
            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="webrtcToggleMute()" id="btnMute">Mute</button>
          </div>
          <audio id="remoteAudio" autoplay></audio>
          <audio id="localAudio" autoplay muted></audio>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Callbacks ({{ pending_callbacks.count }})</div>
        <div class="card-body">
          {% if pending_callbacks %}
            <ul class="list-group list-group-flush">
              {% for cb in pending_callbacks %}
              <li class="list-group-item">
                <div class="d-flex justify-content-between">
                  <span><strong>{{ cb.lead.get_full_name }}</strong></span>
                  <small class="text-muted">{{ cb.scheduled_time }}</small>
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted">No pending callbacks</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sip.js@0.21.2/lib/platform/web/sip.min.js"></script>
<script>
let sipUA = null;
let currentSession = null;
let muted = false;
function setRegBadge(text, cls) {
  const b = document.getElementById('webrtcRegBadge');
  if (!b) return;
  b.className = 'badge ' + cls; b.innerText = text;
}
function attachMedia(session) {
  const remote = document.getElementById('remoteAudio');
  const local = document.getElementById('localAudio');
  const pc = session.sessionDescriptionHandler.peerConnection;
  pc.ontrack = (e) => { remote.srcObject = e.streams[0]; };
}
function webrtcCall() {
  if (!sipUA) return alert('Phone not registered');
  const num = (document.getElementById('webrtcNumber') || {}).value || '';
  if (!num) return alert('Enter a number');
  const cfg = {{ webrtc_config|safe }};
  const target = `sip:${num}@${cfg.server}`;
  const session = sipUA.invite(target, { sessionDescriptionHandlerOptions: { constraints: { audio: true, video: false } } });
  currentSession = session;
  session.on('trackAdded', () => attachMedia(session));
  session.on('accepted', () => { document.getElementById('btnMute').innerText = 'Mute'; muted = false; });
  session.on('bye', () => { currentSession = null; });
  session.on('terminated', () => { currentSession = null; });
}
function webrtcHangup() { if (currentSession) { try { currentSession.bye(); } catch(e) { try { currentSession.terminate(); } catch(_) {} } currentSession = null; } }
function webrtcToggleMute() {
  if (!currentSession) return;
  const pc = currentSession.sessionDescriptionHandler.peerConnection;
  pc.getSenders().forEach(s => { if (s.track && s.track.kind === 'audio') s.track.enabled = muted; });
  muted = !muted; document.getElementById('btnMute').innerText = muted ? 'Unmute' : 'Mute';
}
function webrtcAnswer() { if (currentSession && currentSession.accept) { currentSession.accept({ sessionDescriptionHandlerOptions: { constraints: { audio: true, video: false } } }); } }
try {
  const cfg = {{ webrtc_config|safe }};
  if (cfg && cfg.success && window.SIP) {
    const uri = `sip:${cfg.username}@${cfg.server}`;
    const wsUri = `${cfg.protocol}://${cfg.server}:${cfg.port}/ws`;
    sipUA = new SIP.UA({
      uri,
      transportOptions: { wsServers: [wsUri] },
      authorizationUser: cfg.username,
      password: cfg.password,
      hackWssInTransport: true,
      sessionDescriptionHandlerFactoryOptions: { peerConnectionOptions: { rtcConfiguration: { iceServers: cfg.ice_servers || [] } } }
    });
    sipUA.on('registered', () => { setRegBadge('Registered', 'bg-success'); const el = document.getElementById('phoneStatus'); if (el) { el.classList.remove('offline','connecting'); el.classList.add('registered'); el.innerText = `Ext: ${cfg.extension}`; } });
    sipUA.on('unregistered', () => { setRegBadge('Not Registered', 'bg-secondary'); const el = document.getElementById('phoneStatus'); if (el) { el.classList.remove('registered'); el.classList.add('offline'); el.innerText = 'Not Registered'; } });
    sipUA.on('invite', (session) => { currentSession = session; session.on('trackAdded', () => attachMedia(session)); });
  }
} catch(e) { console.warn('WebRTC init skipped', e); }
</script>
{% endblock %}
