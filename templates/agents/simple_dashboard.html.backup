{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Dashboard — {{ agent.get_full_name|default:agent.username }}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --success: #16a34a;
            --warning: #d97706;
            --danger: #dc2626;
            --info: #0891b2;
            --wrapup: #7c3aed;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-muted: #64748b;
            --shadow: 0 1px 3px rgba(0,0,0,.1);
            --shadow-lg: 0 4px 20px rgba(0,0,0,.12);
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card: #1e293b; --border: #334155;
            --text: #f1f5f9; --text-muted: #94a3b8;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; font-size: 14px; min-height: 100vh; }

        /* ── Header ── */
        .agent-header {
            background: var(--card); border-bottom: 1px solid var(--border);
            padding: 12px 24px; display: flex; align-items: center;
            justify-content: space-between; gap: 12px; flex-wrap: wrap;
            position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow);
        }
        .agent-header h1 { font-size: 1.1rem; font-weight: 700; }
        .header-right { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

        /* ── Status badge ── */
        .status-pill {
            padding: 4px 14px; border-radius: 999px; font-size: 0.78rem;
            font-weight: 700; letter-spacing: .4px; text-transform: uppercase;
        }
        .status-pill.available   { background: #dcfce7; color: #16a34a; }
        .status-pill.busy        { background: #dbeafe; color: #1d4ed8; }
        .status-pill.wrapup      { background: #ede9fe; color: #7c3aed; }
        .status-pill.break, .status-pill.lunch, .status-pill.training, .status-pill.meeting
                                 { background: #fef9c3; color: #854d0e; }
        .status-pill.offline     { background: #f1f5f9; color: #64748b; }

        /* ── Layout ── */
        .agent-layout { display: grid; grid-template-columns: 1fr 320px; gap: 20px; padding: 20px 24px; max-width: 1400px; margin: 0 auto; }
        @media (max-width: 1000px) { .agent-layout { grid-template-columns: 1fr; } }

        /* ── Cards ── */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
        .card-header { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; color: var(--text-muted); }
        .card-body { padding: 18px; }

        /* ── Call panel ── */
        #call-panel { border: 2px solid var(--border); transition: border-color .3s; }
        #call-panel.active  { border-color: var(--success); }
        #call-panel.ringing { border-color: var(--warning); }
        #call-panel.wrapup  { border-color: var(--wrapup); }

        .call-number-display { font-size: 2rem; font-weight: 800; letter-spacing: 1px; color: var(--text); text-align: center; padding: 16px 0 6px; }
        .call-status-badge {
            display: inline-block; padding: 4px 14px; border-radius: 999px;
            font-size: 0.78rem; font-weight: 700; margin: 0 auto; display: block; width: fit-content;
        }
        .call-status-badge.idle     { background: #f1f5f9; color: #64748b; }
        .call-status-badge.ringing  { background: #fef9c3; color: #854d0e; }
        .call-status-badge.connected{ background: #dcfce7; color: #16a34a; }
        .call-status-badge.ended    { background: #fee2e2; color: #dc2626; }
        .call-status-badge.wrapup   { background: #ede9fe; color: #7c3aed; }

        .call-timer { font-size: 1.4rem; font-weight: 700; text-align: center; color: var(--primary); padding: 8px 0; font-variant-numeric: tabular-nums; }

        .call-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 14px; }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 9px 18px; border-radius: 8px; border: none; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all .15s; }
        .btn:disabled { opacity: .5; cursor: not-allowed; }
        .btn-primary   { background: var(--primary); color: #fff; }
        .btn-primary:hover:not(:disabled)  { background: var(--primary-hover); }
        .btn-success   { background: var(--success); color: #fff; }
        .btn-danger    { background: var(--danger); color: #fff; }
        .btn-danger:hover:not(:disabled)   { background: #b91c1c; }
        .btn-warning   { background: var(--warning); color: #fff; }
        .btn-warning:hover:not(:disabled)  { background: #b45309; }
        .btn-secondary { background: #f1f5f9; color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover:not(:disabled){ background: #e2e8f0; }
        .btn-wrapup    { background: var(--wrapup); color: #fff; font-size: 0.9rem; padding: 10px 22px; }
        .btn-wrapup:hover:not(:disabled)   { background: #6d28d9; }

        /* ── Wrapup bar — shown only in wrapup ── */
        #wrapup-bar {
            display: none; background: #ede9fe; border: 2px solid var(--wrapup);
            border-radius: 10px; padding: 14px 18px; margin-bottom: 16px;
            text-align: center;
        }
        #wrapup-bar.visible { display: block; }
        #wrapup-bar h3 { color: var(--wrapup); font-size: 1rem; font-weight: 700; margin-bottom: 4px; }
        #wrapup-bar p  { color: #5b21b6; font-size: 0.85rem; margin-bottom: 12px; }

        /* ── Manual dial ── */
        .manual-dial { display: flex; gap: 8px; }
        .manual-dial input { flex: 1; padding: 9px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 0.9rem; }

        /* ── Status buttons ── */
        .status-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .status-btn { padding: 8px 10px; border: 1.5px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all .15s; text-align: center; }
        .status-btn:hover { border-color: var(--primary); color: var(--primary); }
        .status-btn.active.available { border-color: var(--success); background: #dcfce7; color: var(--success); }
        .status-btn.active.busy      { border-color: #1d4ed8; background: #dbeafe; color: #1d4ed8; }
        .status-btn.active.break,
        .status-btn.active.lunch,
        .status-btn.active.training,
        .status-btn.active.meeting   { border-color: var(--warning); background: #fef9c3; color: #854d0e; }
        .status-btn.active.wrapup    { border-color: var(--wrapup); background: #ede9fe; color: var(--wrapup); }

        /* ── Stats ── */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-item  { background: var(--bg); border-radius: 8px; padding: 12px; text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: .4px; margin-top: 2px; }

        /* ── Lead card ── */
        .lead-field { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .lead-field:last-child { border-bottom: none; }
        .lead-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .lead-value { font-size: 0.9rem; font-weight: 600; }

        /* ── Tabs ── */
        .tab-buttons { display: flex; gap: 4px; border-bottom: 1px solid var(--border); padding: 0 18px; }
        .tab-btn { padding: 10px 14px; border: none; background: none; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all .15s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; padding: 18px; }
        .tab-content.active { display: block; }

        /* ── Toast ── */
        #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 18px; border-radius: 10px; color: #fff; font-size: 0.85rem; font-weight: 600; max-width: 320px; box-shadow: var(--shadow-lg); animation: slideIn .2s ease; }
        .toast.success { background: var(--success); }
        .toast.error   { background: var(--danger); }
        .toast.info    { background: var(--info); }
        .toast.warning { background: var(--warning); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* ── DISPOSITION OVERLAY — full-screen, cannot be dismissed ── */
        #disposition-overlay {
            display: none; position: fixed; inset: 0; z-index: 5000;
            background: rgba(15, 23, 42, .75); backdrop-filter: blur(4px);
            align-items: center; justify-content: center;
        }
        #disposition-overlay.visible { display: flex; }
        .disposition-modal {
            background: var(--card); border-radius: 16px; padding: 28px 32px;
            width: min(500px, 95vw); max-height: 85vh; overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,.4);
        }
        .disposition-modal h2 { font-size: 1.2rem; font-weight: 800; margin-bottom: 4px; }
        .disposition-modal .subtitle { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px; }
        .disposition-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; margin-bottom: 18px; }
        .disp-btn {
            padding: 10px 8px; border: 2px solid var(--border); border-radius: 8px;
            background: var(--card); color: var(--text); font-size: 0.8rem;
            font-weight: 600; cursor: pointer; transition: all .15s; text-align: center;
        }
        .disp-btn:hover   { border-color: var(--primary); color: var(--primary); background: #f0f4ff; }
        .disp-btn.selected{ border-color: var(--primary); background: var(--primary); color: #fff; }
        .disp-btn.sale    { border-color: var(--success); }
        .disp-btn.sale.selected { background: var(--success); }
        .notes-area { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 0.85rem; resize: vertical; min-height: 80px; margin-bottom: 16px; }
        .disposition-footer { display: flex; gap: 10px; justify-content: flex-end; }

        /* ── Connection indicator ── */
        .ws-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .ws-dot.connected    { background: var(--success); }
        .ws-dot.disconnected { background: var(--danger); }

        /* logout block banner */
        #logout-blocked-banner {
            display: none; background: var(--danger); color: #fff;
            text-align: center; padding: 8px 16px; font-size: 0.85rem; font-weight: 600;
        }
        #logout-blocked-banner.visible { display: block; }

        textarea, input { outline: none; }
        textarea:focus, input:focus { border-color: var(--primary); }

        /* ═══════════════════════════════════════════════════════
           STATUS & LOGIN TIMER WIDGET
           Seeded from DB (AgentTimeLog.started_at) — never resets
           on page refresh, identical to admin realtime monitor.
           ═══════════════════════════════════════════════════════ */
        .agent-timers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
            padding: 12px 10px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .at-cell { text-align: center; }
        .at-cell label {
            display: block;
            font-size: 0.62rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .07em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .at-val {
            font-family: 'Courier New', monospace;
            font-size: 1.3rem;
            font-weight: 800;
            letter-spacing: .04em;
            line-height: 1;
        }
        .at-val.status-clr { color: var(--primary); }
        .at-val.login-clr  { color: var(--info); }
        .at-sub { font-size: 0.62rem; color: var(--text-muted); margin-top: 3px; }
    </style>
</head>
<body>

<!-- Logout blocked banner -->
<div id="logout-blocked-banner">
    ⚠️ You cannot log out until you dispose the current call.
</div>

<!-- ══════════════════════════════════════════════
     HEADER
══════════════════════════════════════════════ -->
<header class="agent-header">
    <div>
        <h1>{{ agent.get_full_name|default:agent.username }}</h1>
        <small style="color:var(--text-muted)">
            <span class="ws-dot" id="ws-dot"></span>
            <span id="ws-label">Connecting…</span>
        </small>
    </div>
    <div class="header-right">
        <span class="status-pill" id="agent-status-pill">{{ agent_status.get_status_display }}</span>
        <a href="{% url 'agents:call_history_page' %}" class="btn btn-secondary" style="font-size:0.78rem; padding:6px 12px;">
            <i class="fas fa-history"></i> History
        </a>
        <a id="logout-link" href="{% url 'users:logout' %}" class="btn btn-secondary" style="font-size:0.78rem; padding:6px 12px;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
</header>

<!-- ══════════════════════════════════════════════
     MAIN LAYOUT
══════════════════════════════════════════════ -->
<div class="agent-layout">

    <!-- LEFT COLUMN -->
    <div style="display:flex; flex-direction:column; gap:16px;">

        <!-- Wrapup action bar (shown when in wrapup) -->
        <div id="wrapup-bar">
            <h3><i class="fas fa-clipboard-check"></i> Wrap-Up Required</h3>
            <p>Call ended — please select a disposition to complete the call record.</p>
            <button class="btn btn-wrapup" onclick="openDispositionOverlay()">
                <i class="fas fa-tag"></i> Dispose Call Now
            </button>
        </div>

        <!-- CALL PANEL -->
        <div class="card" id="call-panel">
            <div class="card-header">
                <h2><i class="fas fa-phone"></i> Active Call</h2>
                <span id="call-status-badge" class="call-status-badge idle">Idle</span>
            </div>
            <div class="card-body">
                <div id="call-number-display" class="call-number-display">—</div>
                <div id="call-timer" class="call-timer">00:00</div>

                <div class="call-actions">
                    <!-- Manual dial -->
                    <div class="manual-dial" style="width:100%;">
                        <input type="tel" id="dial-number" placeholder="Enter number to dial…" style="flex:1;">
                        <button class="btn btn-success" id="btn-manual-dial" onclick="manualDial()">
                            <i class="fas fa-phone"></i> Dial
                        </button>
                    </div>
                </div>

                <div class="call-actions" id="active-call-actions" style="display:none;">
                    <button class="btn btn-danger" id="btn-hangup" onclick="hangupCall()">
                        <i class="fas fa-phone-slash"></i> Hang Up
                    </button>
                    <button class="btn btn-secondary" id="btn-mute" onclick="toggleMute()">
                        <i class="fas fa-microphone-slash"></i> Mute
                    </button>
                </div>
            </div>
        </div>

        <!-- LEAD INFO TABS -->
        <div class="card">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showTab('tab-lead')">Lead Info</button>
                <button class="tab-btn" onclick="showTab('tab-script')">Script</button>
                <button class="tab-btn" onclick="showTab('tab-history')">Call History</button>
            </div>
            <div id="tab-lead" class="tab-content active">
                <div id="lead-placeholder" style="text-align:center; color:var(--text-muted); padding:30px 0;">
                    <i class="fas fa-user-circle fa-2x" style="opacity:.4"></i>
                    <p style="margin-top:10px; font-size:0.85rem;">Waiting for call…</p>
                </div>
                <div id="lead-details" style="display:none;">
                    <div class="lead-field"><span class="lead-label">Name</span><span class="lead-value" id="l-name">—</span></div>
                    <div class="lead-field"><span class="lead-label">Phone</span><span class="lead-value" id="l-phone">—</span></div>
                    <div class="lead-field"><span class="lead-label">Email</span><span class="lead-value" id="l-email">—</span></div>
                    <div class="lead-field"><span class="lead-label">Company</span><span class="lead-value" id="l-company">—</span></div>
                    <div class="lead-field"><span class="lead-label">Location</span><span class="lead-value" id="l-location">—</span></div>
                    <div class="lead-field"><span class="lead-label">Status</span><span class="lead-value" id="l-status">—</span></div>
                </div>
            </div>
            <div id="tab-script" class="tab-content">
                <div style="font-size:0.88rem; line-height:1.7; color:var(--text);">
                    {% if script_content %}{{ script_content|linebreaks }}{% else %}<em style="color:var(--text-muted)">No script assigned.</em>{% endif %}
                </div>
            </div>
            <div id="tab-history" class="tab-content">
                <div id="call-history-list" style="font-size:0.85rem; color:var(--text-muted);">No history.</div>
            </div>
        </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div style="display:flex; flex-direction:column; gap:16px;">

        <!-- AGENT STATUS -->
        <div class="card">
            <div class="card-header"><h2>My Status</h2></div>
            <div class="card-body">
                <div class="status-actions">
                    <button class="status-btn available" data-status="available" onclick="setStatus('available')">
                        <i class="fas fa-circle" style="color:var(--success)"></i> Available
                    </button>
                    <button class="status-btn break" data-status="break" onclick="setStatus('break')">
                        <i class="fas fa-coffee"></i> Break
                    </button>
                    <button class="status-btn lunch" data-status="lunch" onclick="setStatus('lunch')">
                        <i class="fas fa-utensils"></i> Lunch
                    </button>
                    <button class="status-btn training" data-status="training" onclick="setStatus('training')">
                        <i class="fas fa-graduation-cap"></i> Training
                    </button>
                    <button class="status-btn meeting" data-status="meeting" onclick="setStatus('meeting')">
                        <i class="fas fa-users"></i> Meeting
                    </button>
                </div>

                <!-- ═══ Status & Login timers — same data as admin monitor ═══ -->
                <div class="agent-timers">
                    <div class="at-cell">
                        <label><i class="fas fa-clock"></i> In Status</label>
                        <div class="at-val status-clr" id="at-status-val">—</div>
                        <div class="at-sub" id="at-status-lbl">Loading…</div>
                    </div>
                    <div class="at-cell">
                        <label><i class="fas fa-sign-in-alt"></i> Login Today</label>
                        <div class="at-val login-clr" id="at-login-val">—</div>
                        <div class="at-sub" id="at-login-since">—</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TODAY'S STATS -->
        <div class="card">
            <div class="card-header"><h2>Today's Stats</h2></div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-total">{{ today_stats.total_calls }}</div>
                        <div class="stat-label">Total Calls</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-answered">{{ today_stats.answered_calls }}</div>
                        <div class="stat-label">Answered</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-talk-time">
                            {% with t=today_stats.talk_time %}{% if t %}{{ t|floatformat:0 }}s{% else %}0s{% endif %}{% endwith %}
                        </div>
                        <div class="stat-label">Talk Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-callbacks">{{ pending_callbacks|length }}</div>
                        <div class="stat-label">Callbacks</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CAMPAIGNS -->
        {% if assigned_campaigns %}
        <div class="card">
            <div class="card-header"><h2>My Campaigns</h2></div>
            <div class="card-body" style="display:flex; flex-direction:column; gap:8px;">
                {% for camp in assigned_campaigns %}
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid var(--border);">
                    <span style="font-weight:600; font-size:0.88rem;">{{ camp.name }}</span>
                    <span style="font-size:0.75rem; background:#dcfce7; color:#16a34a; padding:2px 8px; border-radius:999px;">Active</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

    </div>
</div>

<!-- ══════════════════════════════════════════════
     DISPOSITION OVERLAY (full-screen, blocks UI)
══════════════════════════════════════════════ -->
<div id="disposition-overlay">
    <div class="disposition-modal">
        <h2><i class="fas fa-clipboard-check" style="color:var(--primary)"></i> Select Disposition</h2>
        <div class="subtitle" id="disp-call-info">Please select a disposition for the call before continuing.</div>

        <div class="disposition-grid" id="disp-grid">
            {% for disp in available_dispositions %}
            <button class="disp-btn {% if disp.is_sale %}sale{% endif %}"
                    data-id="{{ disp.id }}" onclick="selectDisposition(this, {{ disp.id }}, '{{ disp.name }}')">
                {{ disp.name }}
            </button>
            {% endfor %}
        </div>

        <textarea class="notes-area" id="disp-notes" placeholder="Add call notes (optional)…"></textarea>

        <div class="disposition-footer">
            <button class="btn btn-primary" id="btn-save-disp" onclick="saveDisposition()" disabled>
                <i class="fas fa-save"></i> Save Disposition
            </button>
        </div>

        <div style="margin-top:12px; font-size:0.75rem; color:var(--text-muted); text-align:center;">
            ⚠️ You must select a disposition to continue. This dialog cannot be dismissed.
        </div>
    </div>
</div>

<!-- Toast container -->
<div id="toast-container"></div>

<!-- ══════════════════════════════════════════════
     DATA INJECTIONS
══════════════════════════════════════════════ -->
{{ webrtc_config|json_script:"webrtc-config-data" }}
{{ available_dispositions|json_script:"dispositions-data" }}

<script>
'use strict';
// ═══════════════════════════════════════════════════════════
//  CONSTANTS & CONFIG
// ═══════════════════════════════════════════════════════════
const AGENT_ID       = {{ agent.id }};
const CSRF_TOKEN     = '{{ csrf_token }}';
const URL_STATUS     = '{% url "agents:update_status" %}';
const URL_CALL_STATUS= '{% url "agents:call_status" %}';
const URL_DISPOSITION= '{% url "agents:set_disposition" %}';
const URL_HANGUP     = '{% url "agents:hangup" %}';
const URL_LEAD_INFO  = '{% url "agents:get_lead_info" %}';
const URL_HEARTBEAT  = '{% url "agents:heartbeat" %}';
const URL_WRAPUP_STATE='{% url "agents:wrapup_state" %}';
const URL_CAN_LOGOUT = '{% url "agents:can_logout" %}';
const URL_STATUS_INFO= '{% url "agents:status_info" %}';  // ADDED
const URL_MANUAL_DIAL= '/agents/api/manual-dial/';

// ═══════════════════════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════════════════════
// ── DB-seeded timer state (survives refresh — same source as admin monitor) ──
let _atSkewMs   = 0;      // server_time_ms - Date.now() for clock accuracy
let _atStatusMs = null;   // Unix ms when current status started
let _atLoginMs  = null;   // Unix ms of first login today
let _atTick     = null;   // setInterval handle for both timers

let state = {
    agentStatus   : '{{ agent_status.status }}',
    callId        : null,
    callActive    : false,
    callTimer     : null,
    callSeconds   : 0,
    isMuted       : false,
    ws            : null,
    wsRetry       : 0,
    selDisp       : null,
    selDispName   : null,
};

// ═══════════════════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
    connectWS();
    startHeartbeat();
    checkWrapupOnLoad();   // ← CRITICAL: restore call state after refresh
    updateStatusUI(state.agentStatus);
    interceptLogout();
    initStatusTimers();    // ← seed timers from DB
    setInterval(refreshStats, 60000);
});

// ═══════════════════════════════════════════════════════════
//  WEBSOCKET
// ═══════════════════════════════════════════════════════════
function connectWS() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const url   = `${proto}//${location.host}/ws/agent/${AGENT_ID}/`;
    try { state.ws = new WebSocket(url); } catch(e) { return scheduleReconnect(); }

    state.ws.onopen = () => {
        state.wsRetry = 0;
        setWsIndicator(true);
        toast('Connected to real-time updates', 'success', 2000);
    };
    state.ws.onmessage = ev => {
        try { handleWsMessage(JSON.parse(ev.data)); } catch(e) {}
    };
    state.ws.onclose = () => {
        setWsIndicator(false);
        scheduleReconnect();
    };
    state.ws.onerror = () => setWsIndicator(false);
}
function scheduleReconnect() {
    state.wsRetry++;
    const delay = Math.min(30000, 1000 * Math.pow(1.5, state.wsRetry));
    setTimeout(connectWS, delay);
}
function setWsIndicator(connected) {
    const dot = document.getElementById('ws-dot');
    const lbl = document.getElementById('ws-label');
    if (dot) dot.className = `ws-dot ${connected ? 'connected' : 'disconnected'}`;
    if (lbl) lbl.textContent = connected ? 'Live' : 'Reconnecting…';
}

function handleWsMessage(msg) {
    const d = msg.data || msg;
    const t = d.type || '';

    if (t === 'call_incoming' || t === 'call_started' || t === 'call_connecting') {
        state.callId = d.call_id || (d.call && d.call.id) || null;
        const num = d.phone_number || (d.call && d.call.number) || d.called_number || '—';
        showActiveCallUI(num, 'ringing');
        if (d.lead_id) loadLead(null, d.lead_id);
    }
    else if (t === 'call_answered' || t === 'call_accepted') {
        showActiveCallUI(
            document.getElementById('call-number-display').textContent,
            'connected'
        );
        startCallTimer();
    }
    else if (t === 'call_ended') {
        stopCallTimer();
        if (d.disposition_needed) {
            state.callId = d.call_id || state.callId;
            enterWrapup(state.callId);
        } else {
            resetCallUI();
        }
    }
    else if (t === 'call_cleared') {
        stopCallTimer();
        resetCallUI();
        updateStatusUI('available');
        toast('Call disposed successfully', 'success');
    }
    else if (t === 'status_changed') {
        state.agentStatus = d.status;
        updateStatusUI(d.status);
        // Keep timer label synced with pushed status (no extra fetch)
        const sl = document.getElementById('at-status-lbl');
        if (sl) sl.textContent = d.display || d.status || '';
    }
    else if (t === 'force_logout') {
        // Supervisor forced logout — show warning then redirect
        toast('⚠️ ' + (d.reason || 'You have been logged out by a supervisor'), 'warning', 4000);
        setTimeout(() => { window.location.href = '/logout/'; }, 2500);
    }
}

// ═══════════════════════════════════════════════════════════
//  HEARTBEAT (every 30s) — prevents zombie sessions
// ═══════════════════════════════════════════════════════════
function startHeartbeat() {
    sendHeartbeat();
    setInterval(sendHeartbeat, 30000);
}
function sendHeartbeat() {
    post(URL_HEARTBEAT, {}).catch(() => {});
}

// ═══════════════════════════════════════════════════════════════════════
//  STATUS & LOGIN TIMERS — seeded from DB, identical to admin monitor
//  Pattern: store Unix-ms anchor → tick = (Date.now() + skew) - anchor
//  This NEVER resets on page refresh because the anchor comes from DB.
// ═══════════════════════════════════════════════════════════════════════
function _atFmt(s) {
    s = Math.max(0, Math.floor(s));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}
function _atElapsed(ms) {
    return ms ? Math.max(0, Math.floor((Date.now() + _atSkewMs - ms) / 1000)) : 0;
}
function _atTickFn() {
    const sv = document.getElementById('at-status-val');
    const lv = document.getElementById('at-login-val');
    if (sv && _atStatusMs) sv.textContent = _atFmt(_atElapsed(_atStatusMs));
    if (lv && _atLoginMs)  lv.textContent = _atFmt(_atElapsed(_atLoginMs));
}

function initStatusTimers() {
    // Fetch reliable timestamps from DB.
    // Uses AgentTimeLog.started_at — same field the admin monitor uses.
    fetch(URL_STATUS_INFO, {
        headers: { 'X-CSRFToken': CSRF_TOKEN, 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(d => {
        if (!d.success) return;

        // Clock-skew correction (compensates for client/server time drift)
        if (d.server_time_ms) _atSkewMs = d.server_time_ms - Date.now();

        _atStatusMs = d.status_changed_at_ms || null;
        _atLoginMs  = d.login_at_ms          || null;

        // Update labels
        const sl = document.getElementById('at-status-lbl');
        if (sl) sl.textContent = d.status_display || d.status || '';

        const ls = document.getElementById('at-login-since');
        if (ls && _atLoginMs) {
            ls.textContent = 'since ' + new Date(_atLoginMs)
                .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Start single shared interval for both timers
        if (_atTick) clearInterval(_atTick);
        _atTick = setInterval(_atTickFn, 1000);
        _atTickFn();  // immediate first render
    })
    .catch(() => {});
}

function refreshStatusTimer(newStatusDisplay) {
    // Called right after a successful setStatus API call.
    // Resets the status timer to 0:00 from THIS moment — no re-fetch needed.
    _atStatusMs = Date.now() + _atSkewMs;
    const sl = document.getElementById('at-status-lbl');
    if (sl && newStatusDisplay) sl.textContent = newStatusDisplay;
    _atTickFn();
}



// ═══════════════════════════════════════════════════════════
//  CHECK WRAPUP ON PAGE LOAD — call state persists after refresh
// ═══════════════════════════════════════════════════════════
function checkWrapupOnLoad() {
    fetch(URL_WRAPUP_STATE, {
        headers: { 'X-CSRFToken': CSRF_TOKEN }
    })
    .then(r => r.json())
    .then(data => {
        if (data.needs_disposition) {
            state.callId = data.call_id;
            // Restore call UI
            if (data.call) {
                const num = data.call.number || '—';
                showActiveCallUI(num, 'wrapup');
            }
            enterWrapup(state.callId, true); // true = silent restore
            toast('⚠️ Please dispose your pending call', 'warning', 8000);
        }
        // Always sync status from DB
        if (data.status) {
            state.agentStatus = data.status;
            updateStatusUI(data.status);
        }
    })
    .catch(() => {});
}

// ═══════════════════════════════════════════════════════════
//  WRAPUP STATE  
// ═══════════════════════════════════════════════════════════
function enterWrapup(callId, silent = false) {
    state.callId = callId;
    state.agentStatus = 'wrapup';

    // Show wrapup bar
    const wb = document.getElementById('wrapup-bar');
    if (wb) wb.classList.add('visible');

    // Style call panel
    const cp = document.getElementById('call-panel');
    if (cp) { cp.classList.remove('active','ringing'); cp.classList.add('wrapup'); }

    // Update badge
    setCallBadge('Wrap-up', 'wrapup');
    updateStatusUI('wrapup');

    // Show logout blocked banner
    const lb = document.getElementById('logout-blocked-banner');
    if (lb) lb.classList.add('visible');

    // Open disposition overlay immediately
    openDispositionOverlay();

    if (!silent) toast('Call ended — please select a disposition', 'warning', 6000);
}

function exitWrapup() {
    state.agentStatus = 'available';

    const wb = document.getElementById('wrapup-bar');
    if (wb) wb.classList.remove('visible');

    const lb = document.getElementById('logout-blocked-banner');
    if (lb) lb.classList.remove('visible');

    resetCallUI();
}

// ═══════════════════════════════════════════════════════════
//  DISPOSITION OVERLAY
// ═══════════════════════════════════════════════════════════
function openDispositionOverlay() {
    const overlay = document.getElementById('disposition-overlay');
    if (overlay) overlay.classList.add('visible');
    // Reset selection
    state.selDisp = null;
    state.selDispName = null;
    document.querySelectorAll('.disp-btn').forEach(b => b.classList.remove('selected'));
    const saveBtn = document.getElementById('btn-save-disp');
    if (saveBtn) saveBtn.disabled = true;
    // Update subtitle with call info
    const sub = document.getElementById('disp-call-info');
    if (sub && state.callId) sub.textContent = `Call #${state.callId} — select a disposition to complete.`;
}

function selectDisposition(btn, id, name) {
    document.querySelectorAll('.disp-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    state.selDisp = id;
    state.selDispName = name;
    const saveBtn = document.getElementById('btn-save-disp');
    if (saveBtn) saveBtn.disabled = false;
}

function saveDisposition() {
    if (!state.selDisp) { toast('Please select a disposition', 'warning'); return; }
    if (!state.callId)  { toast('No call ID — please refresh and try again', 'error'); return; }

    const notes = (document.getElementById('disp-notes') || {}).value || '';
    const saveBtn = document.getElementById('btn-save-disp');
    if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Saving…'; }

    post(URL_DISPOSITION, {
        call_id:        state.callId,
        disposition_id: state.selDisp,
        notes:          notes,
    })
    .then(data => {
        if (data.success) {
            // Close overlay
            const overlay = document.getElementById('disposition-overlay');
            if (overlay) overlay.classList.remove('visible');
            // Clear notes
            const n = document.getElementById('disp-notes');
            if (n) n.value = '';
            // Reset save button
            if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save Disposition'; }
            exitWrapup();
            toast(`Disposition "${state.selDispName}" saved ✓`, 'success');
            state.callId = null;
            refreshStats();
        } else {
            if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save Disposition'; }
            toast(data.error || 'Failed to save disposition', 'error');
        }
    })
    .catch(() => {
        if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save Disposition'; }
        toast('Network error — please try again', 'error');
    });
}

// ═══════════════════════════════════════════════════════════
//  CALL ACTIONS
// ═══════════════════════════════════════════════════════════
function manualDial() {
    const num = (document.getElementById('dial-number') || {}).value?.trim();
    if (!num) { toast('Enter a number to dial', 'warning'); return; }

    post(URL_MANUAL_DIAL, { phone_number: num })
    .then(data => {
        if (data.success) {
            state.callId = data.call_id;
            showActiveCallUI(num, 'ringing');
            toast('Dialing…', 'info');
        } else {
            toast(data.error || 'Dial failed', 'error');
        }
    }).catch(() => toast('Network error', 'error'));
}

function hangupCall() {
    if (!state.callId) { toast('No active call', 'warning'); return; }
    const btn = document.getElementById('btn-hangup');
    if (btn) btn.disabled = true;

    post(URL_HANGUP, { call_id: state.callId })
    .then(data => {
        if (btn) btn.disabled = false;
        stopCallTimer();
        if (data.wrapup || data.success) {
            enterWrapup(state.callId);
        } else {
            toast(data.error || 'Hangup failed', 'error');
        }
    }).catch(() => {
        if (btn) btn.disabled = false;
        toast('Network error during hangup', 'error');
    });
}

function toggleMute() {
    state.isMuted = !state.isMuted;
    const btn = document.getElementById('btn-mute');
    if (btn) {
        btn.innerHTML = state.isMuted
            ? '<i class="fas fa-microphone"></i> Unmute'
            : '<i class="fas fa-microphone-slash"></i> Mute';
        btn.style.background = state.isMuted ? 'var(--warning)' : '';
        btn.style.color = state.isMuted ? '#fff' : '';
    }
    toast(state.isMuted ? 'Muted' : 'Unmuted', 'info', 1500);
}

// ═══════════════════════════════════════════════════════════
//  CALL UI HELPERS
// ═══════════════════════════════════════════════════════════
function showActiveCallUI(number, statusType) {
    const numEl = document.getElementById('call-number-display');
    if (numEl) numEl.textContent = number || '—';

    const panel = document.getElementById('call-panel');
    if (panel) {
        panel.classList.remove('active','ringing','wrapup');
        panel.classList.add(statusType === 'connected' ? 'active' : statusType);
    }

    const activeActions = document.getElementById('active-call-actions');
    if (activeActions) activeActions.style.display = 'flex';

    const dialForm = document.querySelector('.manual-dial');
    if (dialForm) dialForm.style.display = 'none';

    if (statusType === 'connected') {
        setCallBadge('Connected', 'connected');
    } else if (statusType === 'ringing') {
        setCallBadge('Ringing…', 'ringing');
    } else if (statusType === 'wrapup') {
        setCallBadge('Wrap-up', 'wrapup');
    }

    state.callActive = true;
}

function resetCallUI() {
    state.callActive = false;
    stopCallTimer();

    const numEl = document.getElementById('call-number-display');
    if (numEl) numEl.textContent = '—';
    document.getElementById('call-timer').textContent = '00:00';

    const panel = document.getElementById('call-panel');
    if (panel) panel.classList.remove('active','ringing','wrapup');

    const activeActions = document.getElementById('active-call-actions');
    if (activeActions) activeActions.style.display = 'none';

    const dialForm = document.querySelector('.manual-dial');
    if (dialForm) dialForm.style.display = 'flex';

    setCallBadge('Idle', 'idle');
    updateStatusUI(state.agentStatus);

    // Reset lead
    document.getElementById('lead-details').style.display = 'none';
    document.getElementById('lead-placeholder').style.display = 'block';
}

function setCallBadge(text, cls) {
    const badge = document.getElementById('call-status-badge');
    if (!badge) return;
    badge.textContent = text;
    badge.className = `call-status-badge ${cls}`;
}

// ═══════════════════════════════════════════════════════════
//  CALL TIMER
// ═══════════════════════════════════════════════════════════
function startCallTimer() {
    state.callSeconds = 0;
    stopCallTimer();
    state.callTimer = setInterval(() => {
        state.callSeconds++;
        document.getElementById('call-timer').textContent = formatTime(state.callSeconds);
    }, 1000);
}
function stopCallTimer() {
    if (state.callTimer) { clearInterval(state.callTimer); state.callTimer = null; }
}
function formatTime(s) {
    const m = Math.floor(s / 60), sec = s % 60;
    return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

// ═══════════════════════════════════════════════════════════
//  STATUS MANAGEMENT
// ═══════════════════════════════════════════════════════════
function setStatus(status) {
    if (state.agentStatus === 'wrapup') {
        toast('⚠️ Cannot change status — please dispose the call first', 'warning');
        openDispositionOverlay();
        return;
    }
    post(URL_STATUS, { status })
    .then(data => {
        if (data.success) {
            state.agentStatus = data.status;
            updateStatusUI(data.status);
            refreshStatusTimer(data.display || data.status);
        } else if (data.blocked) {
            toast(data.error || 'Cannot change status right now', 'warning');
            if (data.call_id) openDispositionOverlay();
        } else {
            toast(data.error || 'Failed to update status', 'error');
        }
    }).catch(() => toast('Network error', 'error'));
}

function updateStatusUI(status) {
    // Status pill in header
    const pill = document.getElementById('agent-status-pill');
    if (pill) {
        pill.className = `status-pill ${status}`;
        const displayMap = {
            available:'Available', busy:'On Call', wrapup:'Wrap-up',
            break:'Break', lunch:'Lunch', training:'Training',
            meeting:'Meeting', offline:'Offline', system_issues:'System Issues'
        };
        pill.textContent = displayMap[status] || status;
    }
    // Status buttons
    document.querySelectorAll('.status-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.status === status) btn.classList.add('active', status);
    });
    // Logout blocked banner
    const lb = document.getElementById('logout-blocked-banner');
    if (lb) {
        lb.classList.toggle('visible', status === 'wrapup');
    }
}

// ═══════════════════════════════════════════════════════════
//  LOGOUT INTERCEPTION
// ═══════════════════════════════════════════════════════════
function interceptLogout() {
    const logoutLink = document.getElementById('logout-link');
    if (!logoutLink) return;

    logoutLink.addEventListener('click', e => {
        if (state.agentStatus === 'wrapup') {
            e.preventDefault();
            toast('⚠️ You must dispose the call before logging out!', 'warning', 5000);
            openDispositionOverlay();
            return;
        }
        // Double-check with server
        fetch(URL_CAN_LOGOUT, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
        .then(r => r.json())
        .then(data => {
            if (!data.can_logout) {
                e.preventDefault();
                toast(data.reason || 'Cannot log out right now', 'warning', 5000);
                if (data.call_id) {
                    state.callId = data.call_id;
                    openDispositionOverlay();
                }
            } else {
                // Allow navigation
            }
        }).catch(() => {});
    });

    // Also block browser close/reload during wrapup
    window.addEventListener('beforeunload', e => {
        if (state.agentStatus === 'wrapup') {
            e.preventDefault();
            e.returnValue = 'You have a pending call disposition. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
}

// ═══════════════════════════════════════════════════════════
//  LEAD INFO
// ═══════════════════════════════════════════════════════════
function loadLead(callId, leadId) {
    const params = new URLSearchParams();
    if (leadId)  params.append('lead_id', leadId);
    if (callId)  params.append('call_id', callId);

    fetch(`${URL_LEAD_INFO}?${params}`)
    .then(r => r.json())
    .then(data => {
        if (data.success && data.lead) {
            const l = data.lead;
            document.getElementById('l-name').textContent     = `${l.first_name||''} ${l.last_name||''}`.trim() || '—';
            document.getElementById('l-phone').textContent    = l.phone_number || '—';
            document.getElementById('l-email').textContent    = l.email || '—';
            document.getElementById('l-company').textContent  = l.company || '—';
            document.getElementById('l-location').textContent = [l.city, l.state].filter(Boolean).join(', ') || '—';
            document.getElementById('l-status').textContent   = l.status || '—';
            document.getElementById('lead-placeholder').style.display = 'none';
            document.getElementById('lead-details').style.display = 'block';

            // Call history
            if (data.call_history) {
                const histEl = document.getElementById('call-history-list');
                if (histEl) {
                    histEl.innerHTML = data.call_history.length
                        ? data.call_history.map(c => `
                            <div style="padding:6px 0; border-bottom:1px solid var(--border); font-size:0.82rem;">
                                <span style="font-weight:600">${c.date}</span>
                                <span style="color:var(--text-muted); margin:0 6px">${c.status}</span>
                                ${c.disposition ? `<span style="color:var(--primary)">${c.disposition}</span>` : ''}
                            </div>`).join('')
                        : '<em>No history.</em>';
                }
            }
        }
    }).catch(() => {});
}

// ═══════════════════════════════════════════════════════════
//  TABS
// ═══════════════════════════════════════════════════════════
function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    const tab = document.getElementById(id);
    if (tab) tab.classList.add('active');
    const btn = document.querySelector(`[onclick="showTab('${id}')"]`);
    if (btn) btn.classList.add('active');
}

// ═══════════════════════════════════════════════════════════
//  STATISTICS REFRESH
// ═══════════════════════════════════════════════════════════
function refreshStats() {
    fetch('{% url "agents:statistics" %}')
    .then(r => r.json())
    .then(data => {
        if (!data.success) return;
        const el = (id, v) => { const e = document.getElementById(id); if(e) e.textContent = v; };
        el('stat-total',    data.today.total_calls);
        el('stat-answered', data.today.answered_calls);
        el('stat-talk-time', data.today.talk_time + 's');
        el('stat-callbacks', data.pending_callbacks);
    }).catch(() => {});
}

// ═══════════════════════════════════════════════════════════
//  UTILITIES
// ═══════════════════════════════════════════════════════════
function post(url, data) {
    const body = new URLSearchParams({...data, csrfmiddlewaretoken: CSRF_TOKEN});
    return fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': CSRF_TOKEN,
            'X-Requested-With': 'XMLHttpRequest',
        },
        body,
    }).then(r => r.json());
}

function toast(msg, type = 'info', duration = 4000) {
    const ct = document.getElementById('toast-container');
    if (!ct) return;
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    ct.appendChild(t);
    setTimeout(() => t.remove(), duration);
}
</script>
</body>
</html>
