{% extends 'reports/base.html' %}

{% block page_title %}<i class="fas fa-phone text-primary"></i> Call Analytics{% endblock %}
{% block page_description %}Daily trends and call quality{% endblock %}
{% block export_links %}
  <a class="btn btn-sm btn-outline-primary" href="{% url 'reports:export' 'call' 'csv' %}?{{ request.GET.urlencode }}"><i class="fas fa-file-csv"></i> CSV</a>
  <a class="btn btn-sm btn-outline-primary" href="{% url 'reports:export' 'call' 'xlsx' %}?{{ request.GET.urlencode }}"><i class="fas fa-file-excel"></i> Excel</a>
  <a class="btn btn-sm btn-outline-primary" href="{% url 'reports:export' 'call' 'pdf' %}?{{ request.GET.urlencode }}"><i class="fas fa-file-pdf"></i> PDF</a>
{% endblock %}

{% block reports_content %}
{% include 'reports/_filters.html' %}

<div class="card card-report mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3"><i class="fas fa-chart-line text-primary"></i> Calls vs Answered vs Sales</h5>
    <canvas id="callChart" height="90"></canvas>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped table-report align-middle">
    <thead><tr><th>Date</th><th class="text-end">Calls</th><th class="text-end">Answered</th><th class="text-end">Sales</th><th class="text-end">Avg Talk (s)</th></tr></thead>
    <tbody>
    {% for d in daily %}
      <tr>
        <td>{{ d.day }}</td>
        <td class="text-end">{{ d.calls }}</td>
        <td class="text-end">{{ d.answered }}</td>
        <td class="text-end">{{ d.sales }}</td>
        <td class="text-end">{{ d.avg_talk|default:0|floatformat:0 }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="5" class="text-center text-muted">No data for selected period</td></tr>
    {% endfor %}
    </tbody>
  </table>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = [{% for d in daily %}'{{ d.day }}',{% endfor %}];
  const calls = [{% for d in daily %}{{ d.calls }},{% endfor %}];
  const answered = [{% for d in daily %}{{ d.answered }},{% endfor %}];
  const sales = [{% for d in daily %}{{ d.sales }},{% endfor %}];
  new Chart(document.getElementById('callChart'), {
    type: 'bar',
    data: { labels, datasets: [
      { label: 'Calls', data: calls, backgroundColor: 'rgba(102,126,234,0.7)' },
      { label: 'Answered', data: answered, backgroundColor: 'rgba(40,167,69,0.7)' },
      { label: 'Sales', data: sales, backgroundColor: 'rgba(255,107,107,0.8)' }
    ] },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: false }, y: { beginAtZero: true } } }
  });
 </script>
{% endblock %}

