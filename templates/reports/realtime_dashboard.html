{% extends "base.html" %}
{% load static %}

{% block title %}Real-time Monitor{% endblock %}

{% block extra_css %}
<style>
    /* ── Design tokens ─────────────────────────────────────────── */
    :root {
        --available : #16a34a;
        --busy      : #dc2626;
        --wrapup    : #7c3aed;
        --break     : #d97706;
        --offline   : #6b7280;
        --card-bg   : #fff;
        --row-hover : #f8fafc;
        --border    : #e5e7eb;
        --text      : #111827;
        --muted     : #6b7280;
        --font-mono : 'Courier New', monospace;
    }

    /* ── Layout ────────────────────────────────────────────────── */
    .monitor-wrap {
        padding: 1.25rem 2rem 2rem;
        max-width: 1800px;
        margin: 0 auto;
    }
    .monitor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
        flex-wrap: wrap;
        gap: .75rem;
    }
    .monitor-title { font-size: 1.25rem; font-weight: 800; }
    .monitor-meta  { color: var(--muted); font-size: .8rem; }
    .live-badge {
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        background: #fef2f2;
        color: var(--busy);
        font-size: .72rem;
        font-weight: 700;
        padding: 4px 10px;
        border-radius: 20px;
        border: 1px solid #fecaca;
    }
    .live-dot {
        width: 7px; height: 7px;
        border-radius: 50%;
        background: var(--busy);
        animation: pulse-live 1.4s infinite;
    }
    @keyframes pulse-live {
        0%,100%{ opacity:1; transform:scale(1); }
        50%    { opacity:.4; transform:scale(.7); }
    }

    /* ── Stat cards ────────────────────────────────────────────── */
    .stat-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: .875rem;
        margin-bottom: 1.25rem;
    }
    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: .875rem 1.1rem;
        text-align: center;
        box-shadow: 0 1px 4px rgba(0,0,0,.05);
    }
    .stat-card .val  { font-size: 1.75rem; font-weight: 800; line-height: 1; }
    .stat-card .lbl  { font-size: .7rem; color: var(--muted); text-transform: uppercase; letter-spacing:.05em; font-weight:600; margin-top: .2rem; }
    .stat-card.available .val { color: var(--available); }
    .stat-card.busy      .val { color: var(--busy); }
    .stat-card.wrapup    .val { color: var(--wrapup); }
    .stat-card.break     .val { color: var(--break); }
    .stat-card.total     .val { color: #3b82f6; }

    /* ── Filters ───────────────────────────────────────────────── */
    .filter-bar {
        display: flex;
        align-items: center;
        gap: .75rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    .filter-bar select, .filter-bar input[type="search"] {
        padding: .45rem .85rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: .85rem;
        color: var(--text);
        background: #fff;
        min-width: 180px;
    }
    .filter-bar label { font-size: .8rem; font-weight: 600; color: var(--muted); }
    .btn-icon {
        padding: .45rem .9rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: #fff;
        font-size: .8rem;
        font-weight: 600;
        cursor: pointer;
        color: var(--text);
        display: flex; align-items: center; gap: .35rem;
        transition: all .15s;
    }
    .btn-icon:hover { background: #f1f5f9; border-color: #94a3b8; }

    /* ── Agent table ───────────────────────────────────────────── */
    .agent-table-wrap {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 6px rgba(0,0,0,.05);
    }
    .agent-table {
        width: 100%;
        border-collapse: collapse;
        font-size: .875rem;
    }
    .agent-table thead tr {
        background: #f8fafc;
        border-bottom: 2px solid var(--border);
    }
    .agent-table th {
        padding: .75rem 1rem;
        text-align: left;
        font-size: .7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: .06em;
        color: var(--muted);
        white-space: nowrap;
        cursor: pointer;
        user-select: none;
    }
    .agent-table th:hover { color: var(--text); }
    .agent-table td { padding: .7rem 1rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .agent-table tbody tr:last-child td { border-bottom: none; }
    .agent-table tbody tr:hover { background: var(--row-hover); }

    /* Agent name cell */
    .agent-name-cell { display: flex; align-items: center; gap: .625rem; }
    .agent-avatar {
        width: 34px; height: 34px;
        border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        font-size: .8rem; font-weight: 800;
        flex-shrink: 0;
        color: #fff;
    }
    .av-available { background: var(--available); }
    .av-busy      { background: var(--busy); animation: pulse-busy 1.4s infinite; }
    .av-wrapup    { background: var(--wrapup); }
    .av-break, .av-lunch, .av-training, .av-meeting { background: var(--break); }
    .av-offline   { background: var(--offline); }
    @keyframes pulse-busy {
        0%,100%{ box-shadow:0 0 0 0 rgba(220,38,38,.4); }
        50%    { box-shadow:0 0 0 5px rgba(220,38,38,0); }
    }
    .agent-full-name  { font-weight: 600; font-size: .875rem; }
    .agent-username   { font-size: .72rem; color: var(--muted); }

    /* Status badge */
    .status-badge {
        display: inline-flex; align-items: center; gap: .3rem;
        padding: 3px 9px;
        border-radius: 4px;
        font-size: .72rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: .04em;
    }
    .sb-available { background: #dcfce7; color: #166534; }
    .sb-busy      { background: #fee2e2; color: #991b1b; }
    .sb-wrapup    { background: #ede9fe; color: #5b21b6; }
    .sb-break,
    .sb-lunch,
    .sb-training,
    .sb-meeting   { background: #fef3c7; color: #92400e; }
    .sb-offline   { background: #f3f4f6; color: var(--muted); }

    /* Mono timer cells ── KEY: data-start-ms drives accurate ticking */
    .timer-cell {
        font-family: var(--font-mono);
        font-weight: 700;
        font-size: .85rem;
        color: var(--text);
        white-space: nowrap;
    }
    .timer-cell.warn  { color: var(--break); }
    .timer-cell.alert { color: var(--busy); }

    /* Login time */
    .login-timer {
        font-family: var(--font-mono);
        font-size: .82rem;
        color: #3b82f6;
        font-weight: 700;
    }

    /* Call info */
    .call-tag {
        font-size: .75rem;
        color: var(--busy);
        font-weight: 600;
        background: #fee2e2;
        padding: 2px 7px;
        border-radius: 4px;
        display: inline-flex; align-items: center; gap: .25rem;
    }

    /* Breakdown tooltip bar ── shows today's split */
    .breakdown-wrap { position: relative; display: inline-block; }
    .breakdown-bar {
        display: flex;
        height: 6px;
        width: 100px;
        border-radius: 4px;
        overflow: hidden;
        gap: 1px;
        cursor: help;
    }
    .bb-available { background: var(--available); }
    .bb-busy      { background: var(--busy); }
    .bb-wrapup    { background: var(--wrapup); }
    .bb-break     { background: var(--break); }
    .bb-offline   { background: #d1d5db; }
    .breakdown-tip {
        display: none;
        position: absolute;
        bottom: calc(100% + 6px);
        left: 50%; transform: translateX(-50%);
        background: #1e293b;
        color: #fff;
        font-size: .72rem;
        padding: 7px 10px;
        border-radius: 6px;
        white-space: nowrap;
        z-index: 100;
        pointer-events: none;
        min-width: 160px;
    }
    .breakdown-tip::after {
        content: '';
        position: absolute;
        top: 100%; left: 50%; transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: #1e293b;
    }
    .breakdown-wrap:hover .breakdown-tip { display: block; }

    /* Zombie badge */
    .zombie-badge {
        font-size: .68rem;
        font-weight: 700;
        color: #dc2626;
        background: #fee2e2;
        padding: 1px 5px;
        border-radius: 3px;
        margin-left: 4px;
    }

    /* ── Empty / loading ────────────────────────────────────────── */
    .empty-row td {
        text-align: center;
        padding: 3rem;
        color: var(--muted);
        font-size: .875rem;
    }

    /* ── Force logout button ─────────────────────────────────────── */
    .force-logout-btn {
        padding: 4px 10px;
        border: 1px solid #fecaca;
        border-radius: 5px;
        background: #fff1f2;
        color: #dc2626;
        font-size: .75rem;
        cursor: pointer;
        transition: all .15s;
        white-space: nowrap;
    }
    .force-logout-btn:hover {
        background: #dc2626;
        color: #fff;
        border-color: #dc2626;
    }

    /* ── Force logout confirm modal ──────────────────────────────── */
    .fl-modal-bg {
        display: none;
        position: fixed; inset: 0; z-index: 9000;
        background: rgba(15,23,42,.75);
        backdrop-filter: blur(4px);
        align-items: center; justify-content: center;
    }
    .fl-modal-bg.open { display: flex; }
    .fl-modal {
        background: #fff;
        border-radius: 14px;
        padding: 28px 30px 24px;
        width: min(420px, 95vw);
        box-shadow: 0 20px 60px rgba(0,0,0,.35);
        text-align: center;
    }
    .fl-modal .fl-icon {
        width: 56px; height: 56px;
        border-radius: 50%;
        background: #fee2e2;
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.4rem; color: #dc2626;
    }
    .fl-modal h3 { font-size: 1.1rem; font-weight: 800; margin-bottom: .5rem; }
    .fl-modal p  { color: #6b7280; font-size: .875rem; margin-bottom: 1.5rem; line-height: 1.5; }
    .fl-modal .fl-agent-name {
        display: inline-block;
        background: #f1f5f9; border-radius: 6px;
        padding: 4px 12px; font-weight: 700; color: #1e293b;
        margin-bottom: 1.5rem; font-size: .95rem;
    }
    .fl-btns { display: flex; gap: .75rem; justify-content: center; }
    .fl-btn-cancel {
        padding: .6rem 1.5rem; border: 1px solid #e5e7eb;
        border-radius: 7px; background: #fff; color: #374151;
        font-weight: 700; cursor: pointer; font-size: .875rem;
    }
    .fl-btn-confirm {
        padding: .6rem 1.5rem; border: none;
        border-radius: 7px; background: #dc2626; color: #fff;
        font-weight: 700; cursor: pointer; font-size: .875rem;
        display: flex; align-items: center; gap: .4rem;
        transition: filter .15s;
    }
    .fl-btn-confirm:hover { filter: brightness(1.1); }
    .fl-btn-confirm:disabled { opacity: .5; cursor: not-allowed; }
    .spinner {
        display: inline-block;
        width: 18px; height: 18px;
        border: 2px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin .7s linear infinite;
        vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Responsive ─────────────────────────────────────────────── */
    @media (max-width: 900px) {
        .monitor-wrap { padding: 1rem; }
        .agent-table .hide-sm { display: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="monitor-wrap">

    <!-- Header -->
    <div class="monitor-header">
        <div>
            <h1 class="monitor-title">
                <i class="fas fa-satellite-dish" style="color:#3b82f6;margin-right:.4rem;"></i>
                Real-time Agent Monitor
            </h1>
            <p class="monitor-meta">
                Last updated: <span id="last-updated">—</span>
                &nbsp;|&nbsp;
                Next refresh in: <span id="next-refresh">—</span>s
            </p>
        </div>
        <div style="display:flex;align-items:center;gap:.75rem;flex-wrap:wrap;">
            <span class="live-badge"><span class="live-dot"></span> LIVE</span>
            <button class="btn-icon" id="btn-refresh"><i class="fas fa-sync-alt"></i> Refresh Now</button>
            <button class="btn-icon" id="btn-pause"><i class="fas fa-pause"></i> Pause</button>
        </div>
    </div>

    <!-- Stat cards -->
    <div class="stat-row">
        <div class="stat-card total">
            <div class="val" id="cnt-total">—</div>
            <div class="lbl">Total Online</div>
        </div>
        <div class="stat-card available">
            <div class="val" id="cnt-available">—</div>
            <div class="lbl">Available</div>
        </div>
        <div class="stat-card busy">
            <div class="val" id="cnt-busy">—</div>
            <div class="lbl">On Call</div>
        </div>
        <div class="stat-card wrapup">
            <div class="val" id="cnt-wrapup">—</div>
            <div class="lbl">Wrap-up</div>
        </div>
        <div class="stat-card break">
            <div class="val" id="cnt-break">—</div>
            <div class="lbl">Break / Away</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
        <label>Campaign</label>
        <select id="filter-campaign">
            <option value="all">All Campaigns</option>
            {% for c in campaigns %}
            <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
        </select>
        <label>Search</label>
        <input type="search" id="filter-search" placeholder="Agent name…">
        <label>Status</label>
        <select id="filter-status">
            <option value="all">All Statuses</option>
            <option value="available">Available</option>
            <option value="busy">On Call</option>
            <option value="wrapup">Wrap-up</option>
            <option value="break">Break</option>
            <option value="lunch">Lunch</option>
            <option value="training">Training</option>
            <option value="meeting">Meeting</option>
        </select>
        <a href="{% url 'reports:agent_time_report' %}" class="btn-icon" style="text-decoration:none;">
            <i class="fas fa-chart-bar"></i> Time Report
        </a>
    </div>

    <!-- Agent table -->
    <div class="agent-table-wrap">
        <table class="agent-table" id="agent-table">
            <thead>
                <tr>
                    <th data-sort="name">Agent</th>
                    <th data-sort="status">Status</th>
                    <th data-sort="status_time" title="Time in current status — accurate across refreshes">
                        Status Time ↕
                    </th>
                    <th class="hide-sm" data-sort="login_time" title="Total logged-in time today">
                        Login Time Today
                    </th>
                    <th class="hide-sm">Today's Breakdown</th>
                    <th class="hide-sm">Campaign</th>
                    <th>Call</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="agent-tbody">
                <tr class="empty-row">
                    <td colspan="8"><span class="spinner"></span> Loading agents…</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- No-match empty row -->
    <tr id="no-results-row" style="display:none;" class="empty-row">
        <td colspan="8">No agents match the current filters.</td>
    </tr>

</div>

<!-- ── Force Logout Confirmation Modal ───────────────────────────────── -->
<div class="fl-modal-bg" id="fl-modal-bg">
    <div class="fl-modal">
        <div class="fl-icon"><i class="fas fa-sign-out-alt"></i></div>
        <h3>Force Logout Agent?</h3>
        <p>This will immediately end the agent's session and mark them <strong>Offline</strong> in the system.</p>
        <div class="fl-agent-name" id="fl-agent-name">Agent Name</div>
        <div class="fl-btns">
            <button class="fl-btn-cancel" onclick="closeForceLogoutModal()">Cancel</button>
            <button class="fl-btn-confirm" id="fl-confirm-btn" onclick="executeForceLogout()">
                <i class="fas fa-sign-out-alt"></i> Force Logout
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/* ==============================================================
   REAL-TIME MONITOR — Accurate timers that survive page refresh
   ==============================================================

   KEY DESIGN:
   - API returns status_changed_at_ms (Unix ms) for each agent
   - API returns server_time_ms so we can compute clock skew
   - Each timer cell stores data-start-ms (absolute Unix ms)
   - ONE global setInterval ticks ALL cells every second:
       elapsed = floor((Date.now() + skew - startMs) / 1000)
   - On API refresh we only UPDATE data-start-ms if the agent's
     status actually changed — otherwise we leave the ticking
     timer untouched, so refresh NEVER resets a running timer
   ============================================================== */
(function () {
'use strict';

const URL_AGENTS = '{% url "reports:realtime_agents_api" %}';
const REFRESH_MS = 10000;   // poll interval (ms)
const WARN_SECS  = 600;     // 10 min → warn colour
const ALERT_SECS = 1800;    // 30 min → alert colour

let agents       = {};      // { agentId: {...agentData} }
let skewMs       = 0;       // server time - client time (ms)
let paused       = false;
let pollTimer    = null;
let countdown    = REFRESH_MS / 1000;
let sortField    = 'status';
let sortAsc      = true;

// ── Helpers ────────────────────────────────────────────────────
function fmtSeconds(s) {
    s = Math.max(0, Math.floor(s));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

function elapsedSecs(startMs) {
    if (!startMs) return 0;
    return Math.max(0, Math.floor((Date.now() + skewMs - startMs) / 1000));
}

function getInitials(name) {
    if (!name) return '?';
    const parts = name.split(' ');
    return parts.length >= 2
        ? (parts[0][0] + parts[1][0]).toUpperCase()
        : name.slice(0, 2).toUpperCase();
}

function statusBadgeClass(s) {
    return `sb-${s}` in {
        'sb-available':1, 'sb-busy':1, 'sb-wrapup':1,
        'sb-break':1, 'sb-lunch':1, 'sb-training':1,
        'sb-meeting':1, 'sb-offline':1
    } ? `sb-${s}` : 'sb-offline';
}

function avatarClass(s) {
    return `av-${s}` in {
        'av-available':1,'av-busy':1,'av-wrapup':1,
        'av-break':1,'av-lunch':1,'av-training':1,
        'av-meeting':1,'av-offline':1
    } ? `av-${s}` : 'av-offline';
}

function statusLabel(s) {
    const map = {
        available: 'Available', busy: 'On Call', wrapup: 'Wrap-up',
        break: 'Break', lunch: 'Lunch', training: 'Training',
        meeting: 'Meeting', offline: 'Offline',
    };
    return map[s] || s;
}

function fmtBreakdown(bd) {
    const labels = {
        available:'Available',busy:'On Call',
        wrapup:'Wrap-up',break:'Break',lunch:'Lunch',
        training:'Training',meeting:'Meeting',
    };
    return Object.entries(bd)
        .filter(([, v]) => v > 0)
        .map(([k, v]) => `${labels[k] || k}: ${fmtSeconds(v)}`)
        .join(' · ') || 'No data yet';
}

// ── Fetch & update ─────────────────────────────────────────────
function fetchAgents() {
    const campaign = document.getElementById('filter-campaign').value;
    const url = campaign && campaign !== 'all'
        ? `${URL_AGENTS}?campaign_id=${campaign}`
        : URL_AGENTS;

    fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;

            // Compute clock skew once per fetch
            if (data.server_time_ms) {
                skewMs = data.server_time_ms - Date.now();
            }

            // ── CRITICAL: merge, not replace ──────────────────────────────
            // Keep existing timer startMs unless the status actually changed
            data.agents.forEach(a => {
                const existing = agents[a.id];
                if (existing && existing.status === a.status) {
                    // Status unchanged → keep the existing startMs so timer
                    // keeps ticking from the correct position
                    a._startMs   = existing._startMs;
                    a._loginMs   = existing._loginMs;
                } else {
                    // Status changed (or first load) → seed from server timestamp
                    a._startMs   = a.status_changed_at_ms || (Date.now() + skewMs - (a.status_time_secs || 0) * 1000);
                    a._loginMs   = a.login_at_ms || null;
                }
                agents[a.id] = a;
            });

            // Remove agents who went offline (not in response)
            const liveIds = new Set(data.agents.map(a => String(a.id)));
            Object.keys(agents).forEach(id => {
                if (!liveIds.has(id)) delete agents[id];
            });

            renderTable();
            updateStatCards();

            // Update header
            const now = new Date();
            document.getElementById('last-updated').textContent = now.toLocaleTimeString();
        })
        .catch(err => console.error('[Monitor] Fetch error:', err));
}

// ── Render table ───────────────────────────────────────────────
function renderTable() {
    const search    = document.getElementById('filter-search').value.toLowerCase();
    const statusFlt = document.getElementById('filter-status').value;

    let rows = Object.values(agents);

    // Filter
    if (search) {
        rows = rows.filter(a =>
            a.name.toLowerCase().includes(search) ||
            a.username.toLowerCase().includes(search)
        );
    }
    if (statusFlt && statusFlt !== 'all') {
        rows = rows.filter(a => a.status === statusFlt);
    }

    // Sort
    const ord = {'busy':0,'available':1,'wrapup':2,'break':3,'lunch':4,'training':5,'meeting':6};
    rows.sort((a, b) => {
        let va, vb;
        switch (sortField) {
            case 'name'       : va = a.name;   vb = b.name;   break;
            case 'status'     : va = ord[a.status] ?? 9; vb = ord[b.status] ?? 9; break;
            case 'status_time': va = a.status_time_secs || 0; vb = b.status_time_secs || 0; break;
            case 'login_time' : va = a.login_time_secs  || 0; vb = b.login_time_secs  || 0; break;
            default           : va = ord[a.status] ?? 9; vb = ord[b.status] ?? 9;
        }
        const cmp = typeof va === 'string' ? va.localeCompare(vb) : va - vb;
        return sortAsc ? cmp : -cmp;
    });

    if (!rows.length) {
        document.getElementById('agent-tbody').innerHTML = `
            <tr class="empty-row"><td colspan="7">No agents match the current filters.</td></tr>`;
        return;
    }

    const html = rows.map(a => {
        const bd = a.time_breakdown || {};
        const totalBd = Object.values(bd).reduce((s, v) => s + v, 0) || 1;

        const barHtml = `
            <div class="breakdown-wrap">
                <div class="breakdown-bar" title="${fmtBreakdown(bd)}">
                    <div class="bb-available" style="flex:${(bd.available||0)/totalBd}"></div>
                    <div class="bb-busy"      style="flex:${(bd.busy||0)/totalBd}"></div>
                    <div class="bb-wrapup"    style="flex:${(bd.wrapup||0)/totalBd}"></div>
                    <div class="bb-break"     style="flex:${((bd.break||0)+(bd.lunch||0)+(bd.training||0)+(bd.meeting||0))/totalBd}"></div>
                </div>
                <div class="breakdown-tip">
                    <strong>${a.name}</strong><br>
                    ${fmtBreakdown(bd)}
                </div>
            </div>`;

        const callHtml = a.current_call
            ? `<span class="call-tag">
                    <i class="fas fa-phone-volume"></i>
                    ${a.current_call.number || '—'}
                    ${a.current_call.lead_name ? `· ${a.current_call.lead_name}` : ''}
               </span>`
            : a.needs_disposition
            ? '<span class="call-tag" style="background:#ede9fe;color:#5b21b6;"><i class="fas fa-clipboard-check"></i> Disposing</span>'
            : '<span style="color:var(--muted);font-size:.75rem;">—</span>';

        const zombieBadge = a.is_zombie
            ? '<span class="zombie-badge" title="No heartbeat — may be offline">ZOMBIE</span>'
            : '';

        return `
        <tr data-agent-id="${a.id}">
            <td>
                <div class="agent-name-cell">
                    <div class="agent-avatar ${avatarClass(a.status)}">${getInitials(a.name)}</div>
                    <div>
                        <div class="agent-full-name">${a.name}${zombieBadge}</div>
                        <div class="agent-username">@${a.username}${a.extension ? ` · ext ${a.extension}` : ''}</div>
                    </div>
                </div>
            </td>
            <td>
                <span class="status-badge ${statusBadgeClass(a.status)}">
                    ${statusLabel(a.status)}
                </span>
            </td>
            <td>
                <span class="timer-cell" data-start-ms="${a._startMs || ''}" data-agent-id="${a.id}">
                    ${fmtSeconds(elapsedSecs(a._startMs))}
                </span>
            </td>
            <td class="hide-sm">
                <span class="login-timer" data-login-ms="${a._loginMs || ''}"
                      title="Logged in since ${a.login_at_ms ? new Date(a.login_at_ms).toLocaleTimeString() : '—'}">
                    ${a._loginMs ? fmtSeconds(elapsedSecs(a._loginMs)) : '—'}
                </span>
            </td>
            <td class="hide-sm">${barHtml}</td>
            <td class="hide-sm" style="color:var(--muted);font-size:.8rem;">
                ${a.campaign || '<span style="color:var(--muted)">—</span>'}
            </td>
            <td>${callHtml}</td>
            <td>
                <button class="force-logout-btn" data-agent-id="${a.id}" data-agent-name="${a.name}"
                        title="Force logout this agent"
                        onclick="confirmForceLogout(${a.id}, '${a.name.replace(/'/g,"\\'")}')">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </td>
        </tr>`;
    }).join('');

    document.getElementById('agent-tbody').innerHTML = html;
}

// ── Tick all timers every second ───────────────────────────────
// This is the core fix: timers never reset on API refresh because
// they read data-start-ms, not a JS variable that gets overwritten.
setInterval(() => {
    // Status timers
    document.querySelectorAll('[data-start-ms]').forEach(el => {
        const ms = parseInt(el.dataset.startMs, 10);
        if (!ms) return;
        const secs = elapsedSecs(ms);
        el.textContent = fmtSeconds(secs);
        // Colour coding
        el.classList.toggle('warn',  secs >= WARN_SECS  && secs < ALERT_SECS);
        el.classList.toggle('alert', secs >= ALERT_SECS);
    });
    // Login timers
    document.querySelectorAll('[data-login-ms]').forEach(el => {
        const ms = parseInt(el.dataset.loginMs, 10);
        if (!ms) return;
        el.textContent = fmtSeconds(elapsedSecs(ms));
    });
    // Countdown
    if (!paused) {
        countdown = Math.max(0, countdown - 1);
        document.getElementById('next-refresh').textContent = countdown;
    }
}, 1000);

// ── Stat cards ─────────────────────────────────────────────────
function updateStatCards() {
    const rows = Object.values(agents);
    let available = 0, busy = 0, wrapup = 0, brk = 0;
    const breakStatuses = new Set(['break','lunch','training','meeting']);
    rows.forEach(a => {
        if (a.status === 'available') available++;
        else if (a.status === 'busy')  busy++;
        else if (a.status === 'wrapup') wrapup++;
        else if (breakStatuses.has(a.status)) brk++;
    });
    document.getElementById('cnt-total').textContent     = rows.length;
    document.getElementById('cnt-available').textContent = available;
    document.getElementById('cnt-busy').textContent      = busy;
    document.getElementById('cnt-wrapup').textContent    = wrapup;
    document.getElementById('cnt-break').textContent     = brk;
}

// ── Polling ────────────────────────────────────────────────────
function schedulePoll() {
    clearTimeout(pollTimer);
    countdown = REFRESH_MS / 1000;
    if (!paused) {
        pollTimer = setTimeout(() => {
            fetchAgents().then(schedulePoll);
        }, REFRESH_MS);
    }
}
// Wrap fetchAgents to return promise
const origFetchAgents = fetchAgents;
function fetchAgentsAndSchedule() {
    // fetch returns undefined; make it look like a promise
    origFetchAgents();
    return Promise.resolve();
}

// ── Controls ────────────────────────────────────────────────────
document.getElementById('btn-refresh').addEventListener('click', () => {
    clearTimeout(pollTimer);
    fetchAgents();
    schedulePoll();
});

document.getElementById('btn-pause').addEventListener('click', function () {
    paused = !paused;
    this.innerHTML = paused
        ? '<i class="fas fa-play"></i> Resume'
        : '<i class="fas fa-pause"></i> Pause';
    if (!paused) schedulePoll();
});

// Filters re-render without hitting server
document.getElementById('filter-search').addEventListener('input',   renderTable);
document.getElementById('filter-status').addEventListener('change',  renderTable);
document.getElementById('filter-campaign').addEventListener('change', () => {
    fetchAgents(); schedulePoll();
});

// Column sort
document.querySelectorAll('.agent-table th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
        const field = th.dataset.sort;
        if (sortField === field) sortAsc = !sortAsc;
        else { sortField = field; sortAsc = true; }
        renderTable();
    });
});

// ── Boot ───────────────────────────────────────────────────────
fetchAgents();
// Start recursive polling (every REFRESH_MS)
pollTimer = setInterval(() => {
    if (!paused) fetchAgents();
}, REFRESH_MS);

// ── Force Logout ───────────────────────────────────────────────
// Exposed on window so inline onclick attributes can call them.

const URL_FORCE_LOGOUT = '{% url "agents:force_logout" %}';
const FORCE_LOGOUT_CSRF = '{{ csrf_token }}';

let _flPendingAgentId   = null;
let _flPendingAgentName = null;

window.confirmForceLogout = function (agentId, agentName) {
    _flPendingAgentId   = agentId;
    _flPendingAgentName = agentName;
    document.getElementById('fl-agent-name').textContent = agentName;
    document.getElementById('fl-modal-bg').classList.add('open');
    document.getElementById('fl-confirm-btn').disabled = false;
    document.getElementById('fl-confirm-btn').innerHTML =
        '<i class="fas fa-sign-out-alt"></i> Force Logout';
};

window.closeForceLogoutModal = function () {
    document.getElementById('fl-modal-bg').classList.remove('open');
    _flPendingAgentId = null;
};

window.executeForceLogout = function () {
    if (!_flPendingAgentId) return;

    const btn = document.getElementById('fl-confirm-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging out…';

    const body = new URLSearchParams({
        agent_id         : _flPendingAgentId,
        csrfmiddlewaretoken: FORCE_LOGOUT_CSRF,
    });

    fetch(URL_FORCE_LOGOUT, {
        method : 'POST',
        headers: {
            'Content-Type'    : 'application/x-www-form-urlencoded',
            'X-CSRFToken'     : FORCE_LOGOUT_CSRF,
            'X-Requested-With': 'XMLHttpRequest',
        },
        body,
    })
    .then(r => r.json())
    .then(d => {
        window.closeForceLogoutModal();
        if (d.success) {
            // Remove agent from local map immediately so table updates
            delete agents[_flPendingAgentId || d.agent_id];
            renderTable();
            updateStatCards();
            // Show success toast
            _showFlToast(`${d.agent_name} has been logged out.`, 'success');
        } else {
            _showFlToast(d.error || 'Force logout failed', 'error');
        }
    })
    .catch(() => {
        window.closeForceLogoutModal();
        _showFlToast('Network error — try again', 'error');
    });
};

function _showFlToast(msg, type) {
    // Reuse the existing simple toast if present, else fallback
    const existing = document.getElementById('toast');
    if (existing) {
        existing.textContent = msg;
        existing.className = `show ${type}`;
        setTimeout(() => existing.classList.remove('show'), 4000);
        return;
    }
    const t = document.createElement('div');
    t.style.cssText = `position:fixed;bottom:2rem;right:2rem;z-index:9999;
        padding:.75rem 1.5rem;border-radius:8px;color:#fff;font-weight:700;
        font-size:.875rem;background:${type==='success'?'#16a34a':'#dc2626'};
        box-shadow:0 4px 20px rgba(0,0,0,.25);`;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 4000);
}

// Close modal on background click
document.getElementById('fl-modal-bg').addEventListener('click', function (e) {
    if (e.target === this) window.closeForceLogoutModal();
});

// Keyboard Escape closes modal
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') window.closeForceLogoutModal();
});

})();
</script>
{% endblock %}
