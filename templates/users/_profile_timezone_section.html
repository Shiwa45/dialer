{#
  templates/users/_profile_timezone_section.html
  ───────────────────────────────────────────────
  Include inside the existing user-profile template:

      {% include 'users/_profile_timezone_section.html' %}

  Requires:  {% load tz_filters %}  in the parent template.
#}
{% load tz_filters %}

<div class="card mt-4" id="tz-preference-card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-clock me-2 text-primary"></i>Timezone Preference</h5>
        <span class="badge bg-light text-dark border">
            Currently: <strong id="tz-current-label">{{ request.user.profile.timezone|default:"System default" }}</strong>
        </span>
    </div>
    <div class="card-body">
        <p class="text-muted small mb-3">
            Select your preferred timezone. All dates and times will be displayed in this timezone.
            Leave blank to use the system default (<strong>{% system_timezone %}</strong>).
        </p>

        <div class="row g-3 align-items-end">
            <div class="col-md-6">
                <label class="form-label">My Timezone</label>
                <select id="user-tz-select" class="form-select">
                    <option value="">— Use system default ({% system_timezone %}) —</option>
                    {% for tz in tz_choices %}
                    <option value="{{ tz.value }}"
                            data-offset="{{ tz.offset }}"
                            {% if tz.value == request.user.profile.timezone %}selected{% endif %}>
                        {{ tz.offset }} &nbsp; {{ tz.label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <div class="input-group">
                    <span class="input-group-text" id="tz-offset-badge">
                        {% if request.user.profile.timezone %}
                            {{ request.user.profile.timezone | tz_offset }}
                        {% else %}
                            {{ system_tz | tz_offset }}
                        {% endif %}
                    </span>
                    <button class="btn btn-primary" id="save-tz-btn" onclick="saveUserTimezone()">
                        <i class="fas fa-save me-1"></i>Save
                    </button>
                </div>
            </div>
            <div class="col-12" id="tz-save-feedback" style="display:none;"></div>
        </div>
    </div>
</div>

<script>
document.getElementById('user-tz-select').addEventListener('change', function () {
    const selected = this.options[this.selectedIndex];
    document.getElementById('tz-offset-badge').textContent =
        selected.dataset.offset || 'UTC+00:00';
});

function saveUserTimezone() {
    const tz = document.getElementById('user-tz-select').value;
    const btn = document.getElementById('save-tz-btn');
    const fb  = document.getElementById('tz-save-feedback');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving…';

    fetch('{% url "settings:update_user_timezone" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken':  getCookie('csrftoken'),
        },
        body: 'timezone=' + encodeURIComponent(tz),
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-1"></i>Save';
        fb.style.display = 'block';
        if (data.success) {
            fb.className = 'col-12 alert alert-success py-2';
            fb.textContent = data.message || 'Timezone saved!';
            document.getElementById('tz-current-label').textContent =
                tz || 'System default';
        } else {
            fb.className = 'col-12 alert alert-danger py-2';
            fb.textContent = data.error || 'Failed to save timezone.';
        }
        setTimeout(() => { fb.style.display = 'none'; }, 4000);
    })
    .catch(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-1"></i>Save';
        fb.style.display = 'block';
        fb.className = 'col-12 alert alert-danger py-2';
        fb.textContent = 'Network error – please try again.';
    });
}

function getCookie(name) {
    const v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
    return v ? v[2] : null;
}
</script>
